---
title: "Combining WC, WP, LFM, and RWC data into one datasheet"
author: "Indra Boving"
date: "6/3/2022"
output: html_document
---

03-08-2023 notes: 

goodbye individual leaves -- reps are confusing!
lwcs from RWC overload to actual LWC

##setup

```{r setup, include=FALSE}
#install.packages("rstatix")
#devtools::install_github("an-bui/calecopal")

library(data.table)
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
library(gridExtra)
library(calecopal)
library(rstatix)

select = dplyr::select
 
#source("http://goo.gl/UUyEzD") #outlier KD (original function)

source(here::here("scripts","scripts_functions", "figure_info.R"))
```

```{r}
## Data file version (so it's not hard coded in every read_excel() call)
datver <- "20230525"
dataversion <- paste0("Data_", datver)


tlp_qudo <- -2 #these are totally based on eyeballing Kelly's figure
tlp_quag <- -3
```

#---------------
#Rerun processing:
Run all scripts for processing to make sure those are updated: 

(NOTE: if changing datver, will have to change in each of these scripts)

```{r, warning=FALSE, eval=FALSE}
 source(here::here("scripts", "processing-scripts", "leaf_area_processing.R"))
 source(here("scripts","processing-scripts", "alas_processing.R"))
 source(here::here("scripts","processing-scripts", "lfm_processing.R"))
 source(here::here("scripts","processing-scripts", "md_pd_processing.R"))
 source(here::here("scripts","processing-scripts", "wc_processing.R"))
 source(here::here("scripts","processing-scripts", "swc_processing.R"))

#use below if you want to do them all at once.
#list.files("processing-scripts", full.names = TRUE) %>% walk(source)
```
#Combine DFs: 

#####WC:

%in% c(21:40)

Water content data looks like this: 

md_bulk_wet = as.numeric(md_bulk_wet), 
lwc_md_bulk = ((md_bulk_wet-md_bulk_dry)/md_bulk_dry)
lwc_pd_bulk = ((pd_bulk_wet - pd_bulk_dry)/pd_bulk_dry)
lwc_md_leaf = ((ww_g_md - dw_g_md)/dw_g_md)
lwc_pd_leaf = ((ww_g_pd - dw_g_pd)/dw_g_pd)) 

```{r}
wc_df <- read_csv(here("processed-data", paste0("wc_alldates_",datver,".csv")), show_col_types = FALSE) %>% #contains LWC data
  mutate(date = lubridate::ymd(date))%>% 
  select(-...1) %>% 
  mutate(timing = case_when(
    week %in% c(9, 10, 11, 12, 13, 14) ~ "early", 
    week %in% c(15, 16, 17, 18, 19, 20, 21, 29, 33, 37, 38, 40) ~ "late"
  ))%>% 
  mutate(date_wc = date) %>% 
  #select(-date) %>% 
  #drop_na(date_wc)  %>% 
 # drop_na(mpa)  %>% 
  mutate(time  = case_when(
     time %in% c("PD") ~ "pd", 
     time %in% c("MD") ~ "md", 
     TRUE ~"NA"
   ), 
   tree = case_when(
     tree == 2127 ~ 2327, #weird tree
     TRUE ~ tree
   ), 
   lwc_leaf = case_when(
     lwc_leaf >= 5 ~ NA_real_, #weird value
     TRUE ~ lwc_leaf
   )) %>% 
  select(-date) %>% 
  mutate(lwc_leaf = case_when(
    lwc_leaf < 0 ~ NA_real_, 
    TRUE ~ as.numeric(lwc_leaf))) %>% 
  distinct() %>% 
  mutate(week = case_when(
    week %in% c(38) ~ as.numeric(37), 
    TRUE ~ as.numeric(week)
  ))
  

#WP:

wp_df <- read_csv(here("processed-data", paste0("wp_alldates_long_",datver,".csv")), show_col_types = FALSE)  %>%
  #mutate(date = lubridate::ymd(date)) %>% 
  select(-...1) %>% 
  mutate(timing = case_when(
    week %in% c(9, 10, 11, 12, 13, 14) ~ "early", 
    week %in% c(15, 16, 17, 18, 19, 20, 21, 29, 33, 37, 38, 40) ~ "late"
  )) %>%  
  mutate(tree = as.numeric(tree), 
         tree = case_when(
     tree == 2127 ~ 2327, #weird tree
     TRUE ~ tree), 
  date_wp = date) %>% 
  select(-tag, -plot_number, -date )

#WC + WP:

wp_wc_df <- merge(wp_df, wc_df, 
                  by = c("tree","plot", "site", "species", "time", "week"), 
                  all = T) %>% 
  filter(species != "ARCA", 
         species != "LEU") %>% 
  mutate(lwc_bulk = case_when( #remove weird values before we combine leaves and bulk. 
    lwc_bulk > 2.5 ~ NA_real_, 
    TRUE ~ as.numeric(lwc_bulk)
  )) %>% 
  mutate(lwc_bulk = case_when(
    lwc_bulk < 0 ~ NA_real_, 
    TRUE ~ as.numeric(lwc_bulk)
  )) %>% 
  group_by(tree, week, time) %>% 
  mutate(mpa_mean = mean(mpa, na.rm = T), 
         lwc_leaf_mean = mean(lwc_leaf, na.rm=T), 
         lwc_bulk_mean = mean(lwc_bulk, na.rm=T), 
        # lwc_mean = mean(c(lwc_bulk, lwc_leaf), na.rm = T), 
         timing = timing.x) %>% 
  ungroup() %>% 
  #rowwise() %>% 
  #  mutate(lwc_mean = mean(c(lwc_bulk, lwc_leaf), na.rm = T), 
          # timing = timing.x) %>% 
  dplyr::select(-timing.x, -timing.y) %>%
   dplyr::select(-mpa, -rep, -lwc_bulk, -lwc_leaf) %>%
  distinct() %>% 
  group_by(tree, plot, site, species, time, week) %>% 
  mutate(lwc_mean = mean(c_across(c('lwc_leaf_mean', 'lwc_bulk_mean')), na.rm=TRUE)) %>% 
  select(-date_wc, -lwc_leaf_mean, -lwc_bulk_mean) %>% 
    distinct() %>% 
  mutate(week_rwc_link = case_when(
    week %in% c(9, 10, 11) ~ 11, 
    week %in% c(12, 13) ~ 13, 
    week %in% c(14, 15, 16) ~ 15, 
    week %in% c(17, 18) ~ 18, 
    week %in% c(19) ~ 19, 
    week %in% c(20, 21) ~ 21, 
    week %in% c(22) ~ 22, 
    week %in% c(29, 30) ~ 30, 
    week %in% c(33) ~ 37, 
    TRUE ~ as.numeric(week)
  ))

unique(wp_wc_df$week_rwc_link)
unique(rwc_df$week)
#wp_tmp <- wp_wc_df %>% 
 # dplyr::select(tree, plot, site, species, time, mpa, date_wp, date_wc, week)
#
#tree info

trees_sites_df <- wp_wc_df %>% 
  ungroup() %>% 
  select(tree, plot, site, species) %>% 
  distinct()

write_csv(trees_sites_df, here("processed-data", "trees_sites.csv"))
```

#####RWC:

```{r}
rwc_df_raw <- read.csv(here("processed-data", paste0("rwc_alldates_",datver,".csv"))) %>% 
  select(week, tree, type, year, wee )

unique(rwc_df_raw$week)
unique(wp_ad$week)

rwc_df_spp <- merge(rwc_df_raw, trees_sites_df, all = T) 

rwc_noyears <- rwc_df_spp %>% 
  filter(is.na(year)) %>% 
  drop_na(swc_percent) 

rwc_df <- rwc_df_raw %>% 
  mutate(year = case_when(
    year %in% c(NA_real_) ~ 0, 
    TRUE ~ as.numeric(year)
  )) %>% 
  mutate(week_rwc_link = week) %>% 
  group_by(tree, date, type, year) %>% 
  mutate(mean_swc_per_dry_g = mean(swc_per_dry_g)
         , mean_swc_g = mean(swc_g), 
         swc_ww_g = swc_ww_g, 
       swc_dw_g = swc_ww_g) %>% 
  ungroup() %>% 
  mutate(date_rwc = date, 
         week = as.numeric(week)) %>% 
  select(-date) %>% 
  distinct() %>% 
  select(mean_swc_per_dry_g, mean_swc_g, tree, date_rwc, year,type, week_rwc_link,
         #swc_dw_g_y0, swc_ww_g_y0
         ) %>% 
  as.data.frame()

unique(rwc_df$week)

#RWC + WC + WP:

wp_wc_rwc_df <- merge(wp_wc_df, rwc_df,
                    by = c("tree",
                           "week_rwc_link"
                           ),
                    all = T
                    ) %>% 
  mutate(type = case_when(
    type %in% c("leeaf") ~ "leaf", 
    type %in% c("setm") ~ "stem", 
    TRUE ~ as.character(type)
  )) %>% 
  distinct()

wp_wc_rwc_df %>% 
  filter(mean_swc_per_dry_g< 3) %>% 
  ggplot(aes(y = mean_swc_per_dry_g, x = mpa_mean, color = type)) +
  geom_jitter(alpha = .3) +
  facet_wrap(~year)
```

###AL:AS: 

lwc = g water/g dry

lma = g dry/area cm2

```{r}
alas_df_raw <- read_csv(here::here("processed-data", paste0("alas_leaf_area_df_week",datver,".csv")), show_col_types = F) %>% 
  mutate(tree = tree_id) %>% 
  select(tree, week, date,branch, year, lwm_g, ldm_g, l_cm, d_cm, area_cm2, lma_g_cm2, alas_cm2_per_mm2, sla_cm_g) %>% 
  group_by(tree, week, year, branch) 
 # filter()

leaf_number <- read_csv(here(here("Data_20230316","alas_leaf_number.csv")), show_col_types = FALSE) %>% 
  clean_names() %>% 
  mutate(date = mdy(date),
         week = week(date),
         tree = tree_id) %>% 
  select(week, tree, branch, year, leaf_count)

alas_df <- merge(alas_df_raw, leaf_number, by = c("week", "tree", "branch", "year"))

alas_df %>% 
  filter(lma_g_cm2 < .04) %>% 
  ggplot(aes(y = alas_cm2_per_mm2, x = leaf_count, color = week)) +
  geom_jitter() +
  geom_smooth(method = "lm")

wp_wc_rwc_alas_df1 <- merge(wp_wc_rwc_df, alas_df, by = c("week", "tree", "year"), 
  all = T) %>% 
  mutate(lwa_g_cm2 = lwc_mean * lma_g_cm2, 
         ldmc = ldm_g/(ldm_g + mean_swc_per_dry_g)) %>% 
  mutate(tree = case_when(
    tree %in% c(2048) ~ 2348,
     tree %in% c(2049) ~ 2349,
     tree %in% c(2050) ~ 2354,
     tree %in% c(2051) ~ 2351,
     tree %in% c(2052) ~ 2352,
     tree %in% c(2078) ~ 2378,
     tree %in% c(2080) ~ 2380,
     tree %in% c(2081) ~ 2381,
     tree %in% c(2082) ~ 2382,
    tree %in% c(2083) ~ 2383,
    tree %in% c(2393) ~ 2093,
    tree %in% c(2350) ~ 2354,
    tree %in% c(2303) ~ 2330,
    tree %in% c(2434) ~ 2343,
    TRUE ~ as.numeric(tree)
  )) %>% 
  select(-timing, -species, -plot, -site) %>% 
  distinct() 
  

wp_wc_rwc_alas_df <- merge(trees_sites_df, wp_wc_rwc_alas_df1, by = c("tree"), all = T) %>% 
  dplyr::group_by(tree, time, week) %>%
  fill(c(date_wp, mpa_mean, lwc_mean), .direction = "downup") %>%
  dplyr::ungroup() %>% 
  group_by(tree) %>% 
  fill(c(species, site, plot), .direction = "downup") %>% 
  ungroup()

no_spp <- wp_wc_rwc_alas_df %>%  #Need to track down what these are/if they're entered wrong or whent
  filter(is.na(species))

wp_wc_rwc_alas_df %>% 
  select(lma_g_cm2, leaf_count, alas_cm2_per_mm2, week, species) %>% 
  distinct() %>% 
  filter(lma_g_cm2 < .04, 
         #time == "pd"
         ) %>% 
  ggplot(aes(y = alas_cm2_per_mm2, x = leaf_count, color = species)) +
  geom_point() +
 # facet_wrap(~time) +
  geom_smooth(method = "lm")
```

#FINAL 1: What is CWC df
```{r}
write.csv(wp_wc_rwc_alas_df, here("processed-data", paste0("wp_wc_rwc_",datver,".csv"))) 
```


```{r}
# wp_wc_rwc_summary_df <- wp_wc_rwc_df %>% 
 #   group_by(week, tree) %>% 
 #   summarise(mean_md = mean(mpa_md), 
 #             mean_pd = mean(mpa_pd), 
 #             mean_lwc_md_bulk = mean(lwc_md_bulk), 
 #             mean_lwc_pd_bulk = mean(lwc_pd_bulk), 
 #             mean_swc_g = mean(mean_swc_g), 
 #             mean_swc_per_dry_g = mean(mean_swc_per_dry_g))


rwc_df_spp %>% 
  filter(species == "blue oak", 
         year == 0) %>% 
  filter(year %in% c(0,1), 
         swc_per_dry_g < 5, 
         swc_percent < 300) %>% 
  ggplot(aes(y = swc_per_dry_g, 
             x = as.factor(week), 
             color = as.factor(type), 
             #fill = species
             )) +
  geom_boxplot() +
  #facet_wrap(~year, scales = "free") +
  labs(x = "Week", 
       y = "SWC (g water/g dry)", 
       color = "Type") +
  color_two


rwc_df_spp %>% 
  filter(species == "blue oak", 
         year == 0, 
         type == "leaf") %>% 
  filter(year %in% c(0,1), 
         swc_per_dry_g < 5, 
         swc_percent < 300) %>% 
  ggplot(aes(y = swc_per_dry_g, 
             x = as.factor(week), 
             color = as.factor(type), 
             #fill = species
             )) +
  geom_boxplot() +
  #facet_wrap(~year, scales = "free") +
  labs(x = "Week", 
       y = "SWC (g water/g dry)", 
       color = "Type") +
  color_two
```

#####LFM + RWC + ALAS + WC + WP

Here we are splitting the LFM into different categories: stem vs. leaves, and y1 vs. y0. 

```{r}
lfm_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
  mutate(tree = case_when(
    tree %in% c(9382) ~ 2382,
    tree %in% c(3480) ~ 2380,
    tree %in% c(1472) ~ 1478,
    TRUE ~ as.numeric(tree)
  )) 

lfm_rwc_alas_wp_wc_df <- merge(wp_wc_rwc_alas_df, lfm_df, 
                               by = c("tree", "week", "time", "type", "year"), 
                               all = T) %>% 
  filter(tree > 100) %>% 
  distinct()  %>% 
  dplyr::group_by(tree, time, week) %>%
  fill(c(date_wp, mpa_mean, lwc_mean), .direction = "downup") %>%
  dplyr::ungroup() %>% 
  group_by(tree) %>% 
  fill(c(species, site, plot), .direction = "downup") %>% 
  ungroup() %>% 
  mutate(rwc_lfm_percent = ((lfm_wet_wt_g-lfm_dry_wt_g)/lfm_dry_wt_g)/mean_swc_per_dry_g * 100,
         rwc_lwc_percent = ((lwc_mean/mean_swc_per_dry_g)*100)) %>% 
  mutate(rwc_lwc_percent = case_when(
    type %in% c("stem") ~ NA_real_, 
    TRUE ~ as.numeric(rwc_lwc_percent))) %>% 
  distinct()
  #filter(!is.na(rwc_lwc_percent))
```

#*****FINAL (NEW): write.csv

```{r}
write.csv(lfm_rwc_alas_wp_wc_df, here("processed-data", paste0("lfm_rwc_alas_wp_wc_df",datver,".csv")))
```

#--------------------------------

#OLD BELOW:

```{r}
lfm_leaves_y0_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
  filter(type == "leaf", 
         year == 0) %>% 
 mutate(lfm_wet_wt_y0_g = lfm_wet_wt_g, 
         lfm_wet_per_dry_y0_g = lfm_wet_per_dry_g, 
         lfm_dry_wt_y0_g = lfm_dry_wt_g, 
         lfm_y0_percent = lfm_percent, 
         tree = as.numeric(tree)) %>% 
  select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)


lfm_leaves_y1_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
  filter(type == "leaf", 
         year == 1) %>% 
  mutate(lfm_wet_wt_y1_g = lfm_wet_wt_g, 
         lfm_wet_per_dry_y1_g = lfm_wet_per_dry_g, 
         lfm_dry_wt_y1_g = lfm_dry_wt_g, 
         lfm_y1_percent = lfm_percent, 
         tree = as.numeric(tree)) %>% 
  select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)

lfm_both_both_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
  filter(type == "both",
         year == 3)  %>% 
  mutate(lfm_wet_wt_both_g = lfm_wet_wt_g, 
         lfm_wet_per_dry_both_g = lfm_wet_per_dry_g, 
         lfm_dry_wt_both_g = lfm_dry_wt_g, 
         lfm_both_percent = lfm_percent, 
         tree = as.numeric(tree), 
         date_lfm_both = date_lfm) %>% 
  select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)

#Stems: 

lfm_stem_y0_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
  filter(type == "stem", 
         year == 0) %>% 
 mutate(lfm_wet_wt_y0_g = lfm_wet_wt_g, 
         lfm_wet_per_dry_y0_g = lfm_wet_per_dry_g, 
         lfm_dry_wt_y0_g = lfm_dry_wt_g, 
         lfm_y0_percent = lfm_percent, 
         tree = as.numeric(tree)) %>% 
  select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)

lfm_stem_y1_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
  filter(type == "stem",
         year == 1)%>% 
  mutate(lfm_wet_wt_y1_g = lfm_wet_wt_g, 
         lfm_wet_per_dry_y1_g = lfm_wet_per_dry_g, 
         lfm_dry_wt_y1_g = lfm_dry_wt_g, 
         lfm_y1_percent = lfm_percent, 
         tree = as.numeric(tree)) %>% 
  select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)

lfm_stem_both_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
  filter(type == "both",
         year == 1)  %>% 
  mutate(lfm_wet_wt_both_g = lfm_wet_wt_g, 
         lfm_wet_per_dry_both_g = lfm_wet_per_dry_g, 
         lfm_dry_wt_both_g = lfm_dry_wt_g, 
         lfm_both_percent = lfm_percent, 
         tree = as.numeric(tree), 
         date_lfm_both = date_lfm) %>% 
  select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)


#combine: 
lfm_leaves_df <- merge(lfm_leaves_y0_df, lfm_leaves_y1_df, 
                       by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
  distinct() 

lfm_leaves_both_df <- merge(lfm_leaves_df, lfm_both_both_df,
                            by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
  distinct() 


#stems
lfm_stem_df <- merge(lfm_stem_y0_df, lfm_stem_y1_df, 
                       by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
  distinct() 

lfm_stem_both_df <- merge(lfm_stem_df, lfm_stem_both_df,
                            by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
  distinct()

```

#####LFM + RWC + WC + WP (wide):

######RWC calc.

(percent lwc of saturated wc):

```{r}
wp_wc_rwc_lfm_df_wide_leaves <- merge(wp_wc_rwc_df, lfm_leaves_both_df, 
                               by = c("tree", "week", "time"), 
                               all = T) %>% 
  distinct() 

#stem:
wp_wc_rwc_lfm_df_wide_stem <- merge(wp_wc_rwc_df, lfm_stem_both_df, 
                               by = c("tree", "week", "time"), 
                               all = T) %>% 
  distinct() 

#make a shorter name because the long one will be a pain to write out!
all_water_df <- bind_rows(wp_wc_rwc_lfm_df_wide_leaves, wp_wc_rwc_lfm_df_wide_stem) %>% 
  mutate(rwc_percent = ((lwc_mean/mean_swc_per_dry_g)*100), 
        # rwc_percent_y1 = ((lwc_mean/mean_swc_per_dry_g_y1)*100),
         ) %>% 
  filter(!species %in% c("leaf")) %>% 
  distinct()
```

###AL:AS, add to LFM + RWC + WC + WP: 

```{r}
alas_all_water_df <- merge(all_water_df, alas_df, by = c("week", "tree"), all = T) %>% 
  mutate(lwa_g_cm2 = lwc_mean * lma_g_cm2)
```

```{r}
all_water_df_alas <- alas_all_water_df %>% 
  select(week, tree, time, plot, site, species, mpa_mean, lwc_mean, type, mean_swc_per_dry_g, mean_swc_g, lfm_y0_percent, lfm_y1_percent, lfm_both_percent, rwc_percent, lwm_g, ldm_g, area_cm2, lma_g_cm2, alas_cm2_per_mm2, leaf_count, sla_cm_g, lwa_g_cm2, date_wp) %>% 
  distinct() %>% 
  filter(tree > 1000)
```

#FINAL (OLD): write.csv

```{r}
write.csv(all_water_df_alas, here("processed-data", paste0("LWC_LFM_WP_dates",datver,".csv")))
```

#For Sedgwick dataset: 

```{r}
#what we have from processing above: 
sedgwick <- all_water_df_alas %>% 
  select(-lwm_g, -ldm_g, -area_cm2) %>% 
  group_by(tree, date_wp, time) %>% 
  mutate(date = date_wp, 
         lfm_y0_percent = mean(lfm_y0_percent, na.rm = T),
         lfm_y1_percent = mean(lfm_y1_percent, na.rm = T),
         lfm_both_percent = mean(lfm_both_percent, na.rm = T),
         rwc_y0_percent = mean(rwc_percent_y0, na.rm = T),
         rwc_y0_percent = mean(rwc_percent_y0, na.rm = T),
        #  lwa_g_cm2 = mean( lwa_g_cm2, na.rm = T),
         # sla_cm_g = mean( sla_cm_g, na.rm = T),
        #  alas_cm2_per_mm2 = mean(alas_cm2_per_mm2, na.rm = T),
        # lma_g_cm2 = mean(lma_g_cm2, na.rm = T), 
         ) %>% 
#  distinct() %>% 
  ungroup() %>% 
  select(-rwc_percent_y0, -date_wp) %>% 
  select(date, week, tree, time, plot, site, species, 7:20) %>% 
  drop_na(time) %>% 
  distinct()

write.csv(sedgwick, here("processed-data", paste0("SHIFT_summary",datver,".csv")))
```

```{r}
sedgwick %>% 
  filter(sla_cm_g < 200) %>% 
  filter(lma_g_cm2 < 0.05, 
         time == "md") %>% 
  ggplot(aes(y=leaf_count, x = lma_g_cm2, color = species))+
  geom_jitter(alpha = .5) +
  geom_smooth(method = "lm")
```


for Anna's student: 
```{r}
# lfm_mpa_only <- all_water_df %>% 
#   select(tree, plot, site, species, date_lfm, date_wp, week, time, mpa, type, lfm_y0_percent, lfm_y1_percent, lfm_wet_wt_y0_g, lfm_wet_wt_y1_g, lfm_dry_wt_y0_g, lfm_dry_wt_y1_g, lfm_both_percent, lfm_wet_wt_both_g, lfm_dry_wt_both_g) %>% 
#   drop_na(date_lfm) %>% 
#   distinct()
# 
# write.csv(lfm_mpa_only, here("processed-data", paste0("lfm_mpa_shift_",datver,".csv")))
```

NOTE: This just includes leaves, need to make another df or add stems eventually.

```{r}
all_water_df %>% 
  filter(#year %in% c(0,1), 
         mean_swc_per_dry_g_y0 < 5, 
         #swc_percent < 300, 
         species == "blue oak") %>% 
  ggplot(aes(y = mean_swc_per_dry_g_y0, 
             x = as.factor(week), 
            # color = as.factor(type)
             )) +
  geom_boxplot() +
  #facet_wrap(~year) +
  labs(x = "Week", 
       y = "SWC (g water/g dry)", 
       color = "Type") +
  color_two

all_water_df %>% 
  filter(#year %in% c(0,1), 
         mean_swc_per_dry_g_y0 < 5, 
         #swc_percent < 300, 
        # species == "blue oak"
         ) %>% 
  ggplot(aes(y = mean_swc_per_dry_g_y0, 
             x = as.factor(week), 
            color = as.factor(species)
             )) +
  geom_boxplot() +
  #facet_wrap(~year) +
  labs(x = "Week", 
       y = "SWC (g water/g dry)", 
       color = "Species", 
       title = "Leaves, Y0") +
  color_two 
```

######Missings: 

```{r, echo=F}
#wp_wc_rwc_lfm_df_wide_trees_leaves %>%
  all_water_df %>% 
 # filter(species == "blue oak") %>% 
  select(week, time, tree, lwc_mean, species) %>% 
  distinct() %>% 
  drop_na(lwc_mean) %>% 
  group_by(week, time, species) %>% 
  count() %>% 
  ggplot(aes(x = week, y = n, fill = time)) +
  #facet_wrap(~ species) +
  geom_col(stat = "identity") + 
  scale_x_continuous(breaks = seq(9, 40, by = 1)) +
  labs(title = "LWC")
```

Need to find lwcs:

- week 9 (2022 - 02-28),
    -  specifically: tree 2085, 2086, 2087, 2088, 2090, 2348, 2349, 2361
- week 12 (2022-03-25), some middays
- week 15 (2022-04-13), trees: 2369, 2377
- week 17, tree 2383 MD,
- week 18, (2022-04-05), tree 2343 pd, 2346 pd, 2347 pd,  2365 pd, 2367 pd, 2369 pd, (all pds?)
- week 21 (20022-05-23) tree 2025 md, tree 2027 md, 2354 md
- week 29 (2022-07-19) tree 2020 pd, 2030 pd, 2376 pd, 2379 pd, 
- week 33 (2022-08-18) all (still need to be entered?)
- week 37 (2022-09-12 and later) many (still need to be entered?)

```{r, echo=F}
all_water_df %>% 
  select(week, time, tree, mpa_mean, species) %>% 
  unique() %>% 
  drop_na(mpa_mean) %>% 
  group_by(week, time, species) %>% 
  count() %>% 
  ggplot(aes(x = week, y = n, fill = time)) +
 # facet_wrap(~ species) +
  geom_col(#stat = "identity"
    ) + 
  scale_x_continuous(breaks = seq(9, 40, by = 1)) +
  labs(title = "MPa")
```
```{r}
# all_water_df_new <- all_water_df %>% 
#   select(tree, plot, site, species, week, time, lwc_mean, mpa_mean) %>% 
#   distinct()
```

Q: What are we missing??? 

A: A lot....but where??

(This is each date we collected the associated metric, so if NA in that cell then we don't have it)

```{r}
# missings_df <- all_water_df %>% 
#   select(tree, week, species, site, plot, time, date_wp, date_wc, 
#         # date_lfm, 
#          date_rwc
#          ) %>% 
#   filter(if_any(c(date_wp, 
#                   date_wc, 
#                  # date_lfm
#                   ), ~ is.na(.))) %>% 
#   distinct()
# 
# write.csv(missings_df, here("processed-data", paste0("missing_LWC_LFM_WP_dates",datver,".csv")))
```

#####Outliers: 

10/26 - started this but need to confirm how we actually want to deal with outliers before moving ahead.

```{r}
# outs_lwc <- all_water_df %>% 
#   group_by(species, week) %>% 
#   identify_outliers(lwc_leaf)
# 
# outs_lwc_mpa <- all_water_df %>% 
#   group_by(species, week, time) %>% 
#   identify_outliers(mpa)
# 
# outs_lfm <- all_water_df %>% 
#   group_by(species, week, time) %>% 
#   identify_outliers(lfm_y0_percent)

# without outliers: (something like this...)
# df %>% 
#   anti_join(outs, by = c("tree", "week")) %>% 
#   view()
```

#---------------
#Visualize!

####Water content dynamics: 

Bulk vs. individual leaf LWC...they should probably be the same? 

#####Leaf water content:

```{r}
# all_water_df %>% 
#   ggplot(aes(x = lwc_leaf,
#              y = lwc_bulk, 
#              color = species, 
#              size = week)) +
#   geom_jitter(alpha = .5) +
#   geom_abline() +
#   ylim(-1, 3) +
#   xlim(0, 3) +
#   color_two +
#   facet_wrap(~species) +
#   labs(caption = "black line is 1:1")
```


```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   ggplot(aes(y = -1*mpa, 
#              x = lwc_mean, 
#              #color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .6, 
#               aes(color = week)) +
#   geom_smooth(method = "lm", 
#               aes(group = week, 
#                   color = week)) +
#   facet_wrap(~species)+
#   labs(x = "LWC (g water/gram dry)", 
#        y = "MPa", 
#        color = "Week") 
```

```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~species)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week") +
#   color_grad
# ```
# ```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          week > 15
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~species)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week") +
#   color_grad
```

```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          species == "blue oak"
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   drop_na(site) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~site)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week", 
#        title = "blue oak") +
#   color_grad
```


```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          species == "live oak"
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   drop_na(site) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~site)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week", 
#        title = "live oak") +
#   # color_grad
```

#####Relative water content: 

Reminder: RWC is combination of LWC and SWC, where:

SWC = g water/g dry after 2 hour rehydration (mean per tree/time of day/week)
LWC = g water/g dry (mean per tree/time of day/week)

RWC x LWC: 

```{r}
# all_water_df %>% 
#    filter(lwc_mean < 5,
#           mean_swc_per_dry_g_y0 < 5) %>% 
#   ggplot(aes(y = lwc_mean, 
#              x = mean_swc_per_dry_g_y0, 
#              color = week 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~species)+
#   labs(x = "Saturated Leaf Water Content", 
#        y = "Field Leaf Water Content", 
#        caption = "black line is 1:1") +
#   color_grad +
#   geom_abline()
```

```{r}
# all_water_df %>% 
#    filter(lwc_mean < 5,
#           mean_swc_per_dry_g_y0 < 5) %>% 
#   ggplot(aes(y = mpa_mean, 
#              x = mean_swc_per_dry_g_y0, 
#              color = week 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~species)+
#   labs(x = "Saturated Leaf Water Content", 
#        y = "MPa", 
#        #caption = "black line is 1:1"
#        ) +
#   color_grad 
```

```{r}
# all_water_df %>% 
#   filter(rwc_percent_y0 > 0, 
#          rwc_percent_y0 < 300) %>% 
#   ggplot(aes(y = lwc_mean * 100, 
#              x =rwc_percent_y0, 
#              color = week 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~species)+
#   labs(x = "RWC (% of saturated)", 
#        y = "LWC (% of dry)", 
#        caption = "black line is 1:1") +
#   color_grad +
#   geom_abline()
```

RWC vs. MPa

```{r}
# all_water_df %>% 
#    filter(rwc_percent_y0 > 0, 
#           rwc_percent_y0 < 300) %>% 
#   ggplot(aes(y = -1*mpa, 
#              x = rwc_percent_y0, 
#              color = as.factor(week)
#              #size = week
#              )) +
#   geom_jitter() +
#   facet_wrap(~species)+
#   labs(x = "Relative Water Content", 
#        y = "MPa") +
#   color_many
```

```{r}
# all_water_df %>% 
#    filter(rwc_percent_y0 > 0, 
#           rwc_percent_y0 < 300) %>% 
#   ggplot(aes(y = -1*mpa_mean, 
#              x = rwc_percent_y0, 
#              color = interaction(species,time) 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~interaction(species, time))+
#   labs(x = "Relative Water Content", 
#        y = "MPa") +
#   color_many
```
Q: What are the RWCs important for phsyiological thresholds? 

#####LFM: 

LFM x MPa, year 0

```{r}
# all_water_df %>% 
#   filter(lfm_y0_percent > 20, 
#          lfm_y0_percent < 300) %>% 
#   ggplot(aes(y = -1*mpa_mean, 
#              x = lfm_y0_percent, 
#              color = week)) +
#   geom_jitter(alpha = .6) +
#   facet_wrap(~species) +
#   color_grad +
#   labs(y = "MPa", 
#        x = "LFM, Y0")
```

LFM x MPa, year 1

```{r}
# all_water_df %>% 
#   filter(lfm_y1_percent > 20, 
#          lfm_y1_percent < 300) %>% 
#   ggplot(aes(y = -1*mpa, 
#              x = lfm_y1_percent, 
#              color = species)) +
#   geom_point() +
#   color_two +
#   labs(y = "MPa", 
#        x = "LFM, Y1")
```

LFM year 1 vs. year 0

```{r}
# all_water_df %>% 
#   filter(lfm_y1_percent > 20, 
#          lfm_y1_percent < 300,
#          lfm_y0_percent > 20, 
#          lfm_y0_percent < 300)  %>% 
#   ggplot(aes(y = lfm_y0_percent, 
#              x = lfm_y1_percent, 
#              color = species, 
#              size = week)) +
#   facet_wrap(~species) +
#   geom_jitter(alpha = .6) + 
#   geom_abline() +
#   color_two
```



#---------------

#Ongoing issues: 

```{r, echo=F}
# all_water_df %>% 
#   #select(week, time, tree, water_potential, lwc, date) %>% 
#  # unique() %>% 
#   group_by(date_wp, time, species) %>% 
#   count() %>% 
#   ggplot(aes(x = date_wp, y = n, fill = time)) +
#   facet_wrap(~species)+
#   geom_col(stat = "identity") 
```

```{r, echo=F}
# all_water_df %>% 
#   #select(week, time, tree, water_potential, lwc, date) %>% 
#  # unique() %>% 
#   group_by(date_wc, time, species) %>% 
#   count() %>% 
#   ggplot(aes(x = date_wc, y = n, fill = time)) +
#   facet_wrap(~species)+
#   geom_col(stat = "identity") 
```
- water potentials for week 17 piney, cucu, and chamise are missing? (04.25.2022 and 04.27.2022) We have LFM and LWC for this week from those sites however.  

- missing LFM from week 18 (05.04.2022)

- Predawns from early may, middays from end of March are missing (?)













