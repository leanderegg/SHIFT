---
title: "Combining WC, WP, LFM, and RWC data into one datasheet"
author: "Indra Boving"
date: "6/3/2022"
output: html_document
---

##Setup

```{r setup, include=FALSE}
library(data.table)
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
library(gridExtra)
#library(calecopal)
library(rstatix)

select = dplyr::select
 
#source("http://goo.gl/UUyEzD") #outlier KD (original function)

source(here::here("scripts","scripts_functions", "figure_info.R"))
```

#Env. data: 

From dendra: https://dendra.science/orgs/ucnrs/datastreams?faceted=true&scheme=dq&selectStationId=58e68cacdf5ce600012602d6 
```{r}
shift_env <- read_csv(here::here("data", "sedgwick-during-shift.csv")) %>% 
  clean_names() %>% 
  mutate(adt_time = parse_date_time(time,  "m/d/y H:M"), 
         date = as.Date(adt_time), 
         month = month(date))
range(shift_env$date)

shift_early <- shift_env %>% 
  filter(month %in% c(3:6)) %>% 
  mutate(mean_temp = mean(sedgwick_air_temp_avg_deg_c)) %>% 
  select(mean_temp) %>% 
  distinct()
shift_early

shift_late <- shift_env %>% 
  filter(month %in% c(7:9))  %>% 
  mutate(mean_temp = mean(sedgwick_air_temp_avg_deg_c)) %>% 
  select(mean_temp) %>% 
  distinct()
shift_late
```

```{r}
## Data file version (so it's not hard coded in every read_excel() call)
datver <- "20230724"
dataversion <- paste0("Data_", datver)
```

#---------------
#Rerun processing:
Run all scripts for processing to make sure those are updated: 

(NOTE: if changing datver, will have to change in each of these scripts)

```{r, warning=FALSE, eval=FALSE}
 source(here::here("scripts", "0_processing-scripts", "leaf_area_processing.R"))
 source(here("scripts","0_processing-scripts", "alas_processing.R"))
 source(here::here("scripts","0_processing-scripts", "lfm_processing.R"))
 source(here::here("scripts","0_processing-scripts", "md_pd_pheno_processing.R"))
 source(here::here("scripts","0_processing-scripts", "wc_processing.R"))
 source(here::here("scripts","0_processing-scripts", "swc_processing.R"))

#use below if you want to do them all at once.
#list.files("processing-scripts", full.names = TRUE) %>% walk(source)
```
#Tree info:
```{r}
trees_sites_df <- wc_df <- read_csv(here("processed-data", paste0("wc_alldates_",datver,".csv")), show_col_types = FALSE) %>% 
  ungroup() %>% 
  select(tree, plot, site, species) %>% 
  distinct()

sites <- trees_sites_df %>% 
  group_by(site, species#, plot
           ) %>% 
  tally()

sites

write_csv(trees_sites_df, here("processed-data", "trees_sites.csv"))
```

#Combine DFs: 

#####WC:

Water content data looks like this: 

md_bulk_wet = as.numeric(md_bulk_wet), 
lwc_md_bulk = ((md_bulk_wet-md_bulk_dry)/md_bulk_dry)
lwc_pd_bulk = ((pd_bulk_wet - pd_bulk_dry)/pd_bulk_dry)
lwc_md_leaf = ((ww_g_md - dw_g_md)/dw_g_md)
lwc_pd_leaf = ((ww_g_pd - dw_g_pd)/dw_g_pd)) 

Also has bulk dry and wet weights (sum of all leaves)

```{r}
wc_df <- read_csv(here("processed-data", paste0("wc_alldates_",datver,".csv")), show_col_types = FALSE) %>% #contains LWC data
  mutate(date = lubridate::ymd(date))%>% 
  select(-...1) %>% 
  mutate(date_wc = date) %>% 
  select(-date) %>% 
  mutate(time  = case_when(
     time %in% c("PD") ~ "pd", 
     time %in% c("MD") ~ "md", 
     TRUE ~"NA"
   ), 
   tree = case_when(
     tree == 2127 ~ 2327, #weird trees
     tree == 2309 ~ 2379, 
     TRUE ~ tree
   )) %>% 
  distinct() %>% 
  #select(tree, date_wc, time, lwc_bulk, lwc_leaf, rep) %>% 
  ungroup()

head(wc_df)
```


```{r}
#for entering leaf scans in google sheets ('SHIFT LWC Areas & Masses' sheet), sent to Rayna:
wc_df_nona <-wc_df %>%
  #filter_at(vars(lwc_leaf, lwc_bulk), any_vars(!is.na(.))) %>%
  write_csv(here::here("processed-data", "lwc_clean.csv"))

#Try again: 
#
```

###New LWA:

Note: Need to finish entering as of Jan 31, 2024

Using total leaf masses (ww and dw) and total scan (sum of all individually scanned leaves, when that was relevant)


Calculate LMA and see they make sense and if they dont then those are things we're missing. 

```{r}
#This has the updated dry scans, from which we can get an updated LWA to compare with our LWA approximations: 
#From teh 'SHIFT LWC Areas & Masses' sheet
datver_lwa <- "20231128" #where the lwa info is located

lwa_new_df <- read_csv(here(paste0("Data_",datver_lwa), "shift_lwa_new.csv"), show_col_types = FALSE) %>% 
    clean_names() %>% 
  mutate(tree = tree_id, 
         time = pd_or_md,
         date_wc = lubridate::mdy(date), 
         week = week(date_wc), 
         rep = leaf_number) %>% 
  select(tree, date_wc, time, week, dry_scan_area) %>% 
  distinct()

wc_df_lwa <- merge(wc_df, lwa_new_df, by = c("tree", "date_wc", "time", "week"), all = T) %>% 
  # select(tree, time, rep, week, date_wc, dry_scan_area, dm_leaf_g, wm_leaf_g, dm_bulk_g, wm_bulk_g) %>% 
  filter(tree > 100, 
         !(date_wc %in% c("2022-02-28"))) %>% 
  distinct() %>% 
  mutate(dry_scan_area = case_when(
    dry_scan_area > 200 ~ NA_real_, 
    TRUE ~ as.numeric(dry_scan_area))) %>% 
  mutate(area_cm2 = dry_scan_area*1.166899) %>%  #1.166899 = dry to wet mass conversion based on rescanned leaves from al:as collectd on 4/4/22), in leaf_area_processes.R script
  group_by(tree, week, time) %>% 
  mutate(sum_area_cm2 = sum(area_cm2)) %>% 
 # select(tree, date_wc, week, sum_area_cm2, time) %>% 
  distinct() %>% 
  ungroup() %>% 
  mutate(lwa_g_cm2_new = (wm_bulk_g - dm_bulk_g)/sum_area_cm2, 
         lma = dm_bulk_g/sum_area_cm2)

wc_df_lwa  %>% 
  ggplot(aes(y = lwa_g_cm2_new, 
             x = date_wc, 
             color = species)) +
  geom_point()

wc_df_lwa  %>% 
  ggplot(aes(y = dm_bulk_g, 
             x = lma, 
             color = species)) +
  geom_point()
```


###WP:
```{r}
wp_df <- read_csv(here("processed-data", paste0("wp_alldates_long_",datver,".csv")), show_col_types = FALSE)  %>%
  select(-...1) %>% 
  mutate(tree = as.numeric(tree), 
         tree = case_when(
     tree == 2127 ~ 2327, #weird trees
     tree == 2309 ~ 2379, 
     TRUE ~ tree),
  date_wp = date) %>% 
  select(-tag, -plot_number, -date ) 
```

####WC + WP:
```{r}
wp_wc_df <- merge(wp_df, wc_df_lwa, 
                  by = c("tree","time", "week", "species", "plot", "site"), 
                  all = T) %>% 
  filter(species != "ARCA", 
         species != "LEU") %>% 
  distinct() %>% 
#remove weird values before we combine leaves and bulk so that the combined represents the non-weird values
  mutate(lwc_bulk = case_when( 
    lwc_bulk > 2.5 ~ NA_real_, 
    lwc_bulk < 0 ~ NA_real_, 
    TRUE ~ as.numeric(lwc_bulk)
  )) %>% 
   mutate(lwc_leaf = case_when(
     lwc_leaf >= 5 ~ NA_real_, #weird values
    lwc_leaf < 0 ~ NA_real_,
    TRUE ~ as.numeric(lwc_leaf))) %>% 
#combine reps to get mean mpa and lwc per tree; combine bulk and separate lwc: 
  group_by(tree, week, time) %>% 
  mutate(mpa_mean = mean(mpa, na.rm = T), 
        # sum_area_cm2 = sum(area_cm2), #sum leaf area across all reps
         lwc_leaf_mean = mean(lwc_leaf, na.rm=T), 
         lwc_bulk_mean = mean(lwc_bulk, na.rm=T), 
         lwc_bulk_leaf_diff = lwc_leaf_mean-lwc_bulk_mean) %>% #see if there are any huge differences between leaves and bulk
  ungroup() %>% 
  dplyr::select(-rep) %>%
  distinct() %>% 
  group_by(tree, plot, site, species, time, week) %>% 
#when there are bigish differences, replace the combined bulk+leaf with just the bulk; otherwise take the mean of both. 
  mutate(lwc_mean = case_when(
    lwc_bulk_leaf_diff < -.3 ~ lwc_bulk_mean, 
    lwc_bulk_leaf_diff > .32 ~ lwc_leaf_mean,
   # lwc_mean = NA ~ lfm,
    TRUE ~ mean(c_across(c('lwc_leaf_mean', 'lwc_bulk_mean')), na.rm=TRUE)
    )) %>% 
  select(-date_wc, -lwc_leaf_mean, -lwc_bulk_mean) %>% 
  distinct() %>% 
#since we didn't collect RWC every week, create a column we can use to link RWC to all of the closest LWC weeks (should probably linearly interpolate at some point)
  mutate(week_rwc_link = case_when(
    week %in% c(9, 10, 11) ~ 11, 
    week %in% c(12, 13) ~ 13, 
    week %in% c(14, 15, 16) ~ 15, 
    week %in% c(17, 18) ~ 17, 
    week %in% c(19) ~ 19, 
    week %in% c(20, 21) ~ 21, 
    week %in% c(22) ~ 21, 
    week %in% c(29, 30) ~ 30, 
    week %in% c(33) ~ 37, 
    TRUE ~ as.numeric(week)
  ),
#since we didn't collect alas every week, create a column we can use to link LMA to all of the closest LWC weeks (should probably linearly interpolate at some point):
  week_alas_link = case_when(
    week %in% c(9, 10) ~ 10, 
    week %in% c(11) ~ 11, 
    week %in% c(12, 13) ~ 13, 
    week %in% c(14, 15) ~ 14, 
    week %in% c(16, 17, 18) ~ 17, 
    week %in% c(19, 20, 21) ~ 21, 
    week %in% c(29, 30) ~ 29, 
    week %in% c(33) ~ 37, 
    week %in% c(33) ~ 40, 
    TRUE ~ as.numeric(week)
  )) %>% 
  mutate(timing = case_when( #define early and late seasons as before and after week 17 (April end week)
    week %in% c(9, 10, 11, 12, 13, 14, 15, 16) ~ "early", 
    week %in% c(17, 18, 19, 20, 21, 29, 33, 37, 38, 40) ~ "late"
  )) %>% 
  filter(!if_all(c(mpa_mean,lwc_mean), is.na)) %>% 
  select(-lwc_leaf, -lwc_bulk, - lwc_bulk_leaf_diff) %>% 
  distinct() %>% 
  mutate(type = "leaf") #call these all leaves, becuase they are

write.csv(wp_wc_df, here::here("processed-data", "wp_wc_df.csv"))
#view(wp_wc_df)
```

#####RWC:

```{r}
rwc_df_raw <- read.csv(here("processed-data", paste0("rwc_alldates_",datver,".csv"))) 

rwc_df_spp <- merge(rwc_df_raw, trees_sites_df, all = T) 

rwc_df <- rwc_df_raw %>% 
  mutate(year = case_when(
    year %in% c(NA_real_) ~ 0, #assume no year listed is year 0
    TRUE ~ as.numeric(year)
  )) %>% 
  mutate(week_rwc_link = case_when(
    week %in% c(22) ~ 21, #no mpas for week 22 (prob becuase of week split in week function), so make that 21
    TRUE ~ as.numeric(week))) %>% 
  group_by(tree, date, type, year) %>% 
#remove absurd values -- issue with wet leaves having drops on them? 
  mutate(swc_per_dry_g = case_when(
    swc_per_dry_g > 5 ~ NA_real_, 
    TRUE ~ as.numeric(swc_per_dry_g)
  )) %>% 
  mutate(mean_swc_per_dry_g = mean(swc_per_dry_g, na.rm = T), 
         mean_swc_g = mean(swc_g, na.rm = T), 
         swc_ww_g = swc_ww_g, 
         swc_dw_g = swc_dw_g) %>% 
  ungroup() %>% 
  mutate(date_rwc = date, 
         week = as.numeric(week), 
         type_rwc = type) %>% 
  select(-date) %>% 
  distinct() %>% 
  select(mean_swc_per_dry_g, mean_swc_g, tree, date_rwc, year,type_rwc, week_rwc_link,
         ) %>% 
  as.data.frame()

unique(rwc_df$week)
```

###RWC + WC + WP:

Merge those. MPas, LWC are repeated because they align with swc leaves and stems of different years. 

```{r}
wp_wc_rwc_df <- merge(wp_wc_df, rwc_df,
                    by = c("tree", "week_rwc_link"),
                    all = T
                    ) %>% 
  mutate(type_rwc = case_when(
    type_rwc %in% c("leeaf") ~ "leaf", 
    type_rwc %in% c("setm") ~ "stem", 
    TRUE ~ as.character(type_rwc)
  )) %>% 
  distinct() %>% 
  mutate(week_wp = week) %>% 
  mutate(year = case_when(
    year %in% c(NA) ~ 0, 
    TRUE ~ as.numeric(year)
  ))
```

SWC Figure: 
```{r}
wp_wc_rwc_df %>% 
  filter(mean_swc_per_dry_g < 3, 
         mean_swc_per_dry_g > .3, 
         !year == 3) %>% 
  mutate(growth_words = case_when(
    year == 0 ~ "new growth",
    year == 1 ~ "previous year growth", 
    year %in% c(2, 3) ~ "old growth", 
    TRUE ~ as.character(year)
  )) %>% 
  ggplot(aes(y = mean_swc_per_dry_g, x = mpa_mean, color = type_rwc)) +
  geom_jitter(alpha = .3) +
  facet_wrap(~growth_words) +
  geom_smooth(method = "lm", se = F)+
  color_leaves_stems +
  labs(y = "Saturated WC (g wet/g dry)", 
       x = "Water Potential (-MPa)")

wp_wc_rwc_df %>% 
  filter(mean_swc_per_dry_g < 3, 
         mean_swc_per_dry_g > .3, 
         !year == 3, 
         year == 0, 
         type_rwc == "leaf") %>% 
  drop_na(week) %>% 
  # mutate(growth_words = case_when(
  #   year == 0 ~ "new growth",
  #   year == 1 ~ "previous year growth", 
  #   year %in% c(2, 3) ~ "old growth", 
  #   TRUE ~ as.character(year)
  # )) %>% 
  ggplot(aes(y = mean_swc_per_dry_g, x = mpa_mean, color = as.factor(week))) +
  geom_jitter(alpha = .3) +
 # facet_wrap(~growth_words) +
  #geom_smooth(method = "lm", se = F)+
  color_many +
  #color_leaves_stems +
  labs(y = "Saturated WC (g wet/g dry)", 
       x = "Water Potential (-MPa)", 
       color = "Week")
```
###AL:As & LWA: 

lwc = g water/g dry
lma = g dry/area cm2

```{r}
alas_df_raw <- read_csv(here::here("processed-data", paste0("alas_leaf_area_df_week",datver,".csv")), show_col_types = F) %>% 
  rename(tree = tree_id) %>% 
  mutate(tree = case_when( #weird trees, misentered
    tree %in% c(2048) ~ 2348,
     tree %in% c(2049) ~ 2349,
     tree %in% c(2050) ~ 2354,
     tree %in% c(2051) ~ 2351,
     tree %in% c(2052) ~ 2352,
     tree %in% c(2078) ~ 2378,
     tree %in% c(2080) ~ 2380,
     tree %in% c(2081) ~ 2381,
     tree %in% c(2082) ~ 2382,
    tree %in% c(2083) ~ 2383,
    tree %in% c(2393) ~ 2093,
    tree %in% c(2350) ~ 2354, # I remember doing this a lot :( 
    tree %in% c(2303) ~ 2330,
    tree %in% c(2434) ~ 2343,
    TRUE ~ as.numeric(tree)
  )) %>% 
  mutate(alas_measured = "yes")

leaf_number <- read_csv(here(here("Data_20230316","alas_leaf_number.csv")), show_col_types = FALSE) %>% 
  clean_names() %>% 
  mutate(date = mdy(date),
         week = week(date),
         tree = tree_id) %>% 
  select(week, tree, branch, sub_branch, year, leaf_count) %>% 
  mutate(tree = case_when(
    tree %in% c(2048) ~ 2348,
     tree %in% c(2049) ~ 2349,
     tree %in% c(2050) ~ 2354,
     tree %in% c(2051) ~ 2351,
     tree %in% c(2052) ~ 2352,
     tree %in% c(2078) ~ 2378,
     tree %in% c(2080) ~ 2380,
     tree %in% c(2081) ~ 2381,
     tree %in% c(2082) ~ 2382,
    tree %in% c(2083) ~ 2383,
    tree %in% c(2393) ~ 2093,
    tree %in% c(2350) ~ 2354,
    tree %in% c(2303) ~ 2330,
    tree %in% c(2434) ~ 2343,
    TRUE ~ as.numeric(tree)
  ))

alas_df <- merge(alas_df_raw, leaf_number, by = c("week", "tree", "branch", "year", "sub_branch")) %>% 
  distinct() %>% 
  select(-'...1')

#take the mean value for each tree, week, keeping years separate too. This dataset is best for joining with wc and mpa, as those also have single row per week, tree, year (because of bulk lwc metric)

alas_df_means <- alas_df %>% 
  group_by(week, tree, year) %>% 
  mutate(alas_cm2_per_mm2 = mean(alas_cm2_per_mm2, na.rm = T), 
         mean_leaf_count = mean(leaf_count, na.rm = T), 
         lma_g_cm2 = mean(lma_g_cm2, na.rm = T), 
         sla_cm_g = mean(sla_cm_g, na.rm = T), 
         ldm_g = mean(ldm_g, na.rm = T), 
         leaf_count = mean(leaf_count, na.rm = T)) %>% 
  ungroup() %>% 
  select(tree, week, alas_cm2_per_mm2, lma_g_cm2, sla_cm_g, ldm_g, leaf_count, year, alas_measured) %>% 
  distinct() %>% 
  mutate(week_alas_link = week, 
         type = "leaf") %>% 
  select(-week) 
```

```{r}
#Merge with OG df; #merge alas_df_means with the df with wp, wc, and rwc-related values: 
wp_wc_rwc_alas_df1 <- merge(wp_wc_rwc_df, alas_df_means, by = c("week_alas_link", "tree", "year", "type"), 
  all = T) %>% 
  group_by(week_alas_link, tree, year) %>% 
  mutate(lwa_g_cm2 = lwc_mean * lma_g_cm2,
         ldmc = ldm_g/(ldm_g + mean_swc_per_dry_g))  %>% 
  select(-timing, -species, -plot, -site) %>% 
  distinct() %>% 
  filter() %>% 
  mutate(week = case_when(
    week == NA ~ week_alas_link, 
    TRUE ~ as.numeric(week)
  )) %>% 
  mutate(type = case_when(
    type == NA ~ type_rwc, 
    TRUE ~ as.character(type)
  )) 

#view(wp_wc_rwc_alas_df1)
```

#New vs. old lwa: 

```{r}
wp_wc_rwc_alas_df1 %>% 
  ggplot(aes(y = lwa_g_cm2, 
             x = lwa_g_cm2_new,
             color = species)) +
  geom_point() +
  geom_abline() +
  xlim(0, .05) +
  ylim(0, .05)
  
```


```{r}
wp_wc_rwc_alas_df <- merge(trees_sites_df, wp_wc_rwc_alas_df1, by = c("tree"), all = T) %>% 
  dplyr::group_by(tree, time, week) %>%
  fill(c(date_wp, mpa_mean, lwc_mean), .direction = "downup") %>%
  dplyr::ungroup() %>% 
  group_by(tree) %>% 
  fill(c(species, site, plot), .direction = "downup") %>% 
  ungroup() %>% 
  mutate(
    rwc = (lwc_mean/mean_swc_per_dry_g)*100,
    week = case_when(
      week %in% c(13) ~ 14, #combine dates that are very close together (week() just split at the wrong spot)
      week %in% c(11) ~ 10,
    #  week %in% c(18) ~ 19, #4 days apart, 
      TRUE ~ week
  )) %>%
  filter(!(week == 18)) %>% #remove week 18 because mostly did middays and repeated most of those trees 4 days later on the 19
  mutate(tree = as.character(tree))  %>% 
  group_by(tree, week, time) %>% #combine years to get a year mean
  mutate(water_potential = mean(mpa_mean, na.rm = T), 
         ldmc_mean = mean(ldmc, na.rm = T),
         lma_g_cm2_mean= mean(lma_g_cm2, na.rm = T),
         mpa_mean = mean(mpa_mean, na.rm = T), 
         tree_factor = as.factor(tree), 
         lwc_mean = mean(lwc_mean),
         alas_cm2_per_mm2_mean = mean(alas_cm2_per_mm2, na.rm = T), 
         lwa_g_cm2_mean = mean(lwa_g_cm2, na.rm = T), 
         rwc_mean = mean(rwc, na.rm = T), 
         swc_per_dry_g_mean = mean(mean_swc_per_dry_g, na.rm = T)
         ) %>% 
  ungroup() %>% 
  dplyr::distinct() %>% 
  #filter(!week == 9)%>% 
  group_by(tree, week) %>% 
  fill(alas_cm2_per_mm2, date_wp, lma_g_cm2_mean, ldmc_mean, leaf_count,.direction = "downup") %>% 
  ungroup() %>% 
  distinct() %>% 
  drop_na(time) 
```



#Writte .csv:

####Dataset with everything, both means and actual values: 
```{r}
write.csv(wp_wc_rwc_alas_df, here("processed-data", paste0("wp_wc_rwc_",datver,".csv"))) 
```


####**Dataset for analysis of LWC, MPA, LWA for manuscript:

This has only leaves, with one row per week/tree/time/year:
```{r}
analysis_bothspp_df <- wp_wc_rwc_alas_df %>% 
  filter(#species == "blue oak", 
         type == "leaf",
         #lwa_g_cm2 < 0.025, #some weirdly high values?
         !(week == 29 & lwc_mean > 1)
         )  %>% #one weird value in week 29)
  select(week, time, tree, plot, site, species, 
         mpa_mean, lwc_mean, lma_g_cm2_mean, 
         ldmc_mean, alas_cm2_per_mm2_mean, lwa_g_cm2_mean, lwa_g_cm2_new,leaf_count, swc_per_dry_g_mean, rwc_mean, date_wp, week_alas_link) %>% 
  distinct() %>% 
  rename(lwa_g_cm2 = lwa_g_cm2_mean, 
         lma_g_cm2 = lma_g_cm2_mean,
         alas_cm2_per_mm2 = alas_cm2_per_mm2_mean,
         ldmc = ldmc_mean, 
         water_potential = mpa_mean, 
         rwc = rwc_mean) %>% 
  group_by(tree, time, week) %>% 
  # mutate(alas_cm2_per_mm2 = case_when(
  #   alas_cm2_per_mm2 > 100 ~ NA_real_, #remove alas outliers
  #   TRUE ~ as.numeric(alas_cm2_per_mm2)
  # )) %>% 
   mutate(tree = as.character(tree),
          #tree_week = paste(tree, week, sep = "_"),
          time_season = case_when(
    week <= 17 ~ "before leafout", 
    week > 17 ~ "after leafout", 
    TRUE ~ as.character("none")
  )) %>%  
  filter(!(week == 29 & lwc_mean < .451), #weird values, remove for now?
         !(week == 15 & lwc_mean < .7), 
         !(week == 33 & tree == 2347), 
        # !(week == 18), #seems off
         #lwa_g_cm2 < 0.025 #weird outliers due to LMA, probably
  ) %>%
  mutate(water_potential = -1*water_potential, 
         lwc = lwc_mean)

write.csv(analysis_bothspp_df, here("processed-data", paste0("analysis_bothspp",datver,".csv"))) 

#just blue oaks: 
analysis_df <- analysis_bothspp_df %>% 
  filter(species %in% c("blue oak"))
  
write.csv(analysis_df, here("processed-data", paste0("analysis",datver,".csv"))) 
```

View LWA:
```{r}
analysis_bothspp_df %>% 
 # drop_na(lwa_g_cm2, lwa_g_cm2_new) %>% 
  ggplot(aes(y = lwa_g_cm2, 
             x = lwa_g_cm2_new, 
             color = species)) +
  geom_point()

str(analysis_df)
```

#Sample size/week

- What are the counts per week?
- How often did we measure both pd and md for same tree?
```{r}
lwc_counts <- analysis_df %>% 
  drop_na(lwc_mean) %>% 
  select(lwc_mean, tree, time) %>% 
  group_by(week, time) %>% 
  count() %>% 
  rename(n_lwc = n)

lwa_counts <- analysis_df %>% 
  select(lwa_g_cm2, tree, time) %>% 
  drop_na(lwa_g_cm2) %>% 
  group_by(week, time) %>% 
  count() %>% 
  rename(n_lwa = n)

counts <- merge(lwa_counts, lwc_counts, 
                by = c("week","time")) %>% 
  mutate(paired_or_all = "all trees")

 #only paired samples: 

lwc_counts_paired <- analysis_df %>% 
  drop_na(lwc_mean) %>% 
  select(lwc_mean, tree, time) %>% 
  group_by(tree, week) %>% 
  filter(all(c("pd", "md") %in% time)) %>%
  ungroup() %>% 
  distinct() %>% 
  group_by(week, time) %>% 
  count() %>% 
  rename(n_lwc = n) %>% 
  filter(time == "md") %>% 
  select(-time)

lwa_counts_paired <- analysis_df %>% 
  drop_na(lwa_g_cm2) %>% 
  select(lwa_g_cm2, tree, time) %>% 
  group_by(tree, week) %>% 
  filter(all(c("pd", "md") %in% time)) %>%
  ungroup() %>% 
  distinct() %>% 
  group_by(week, time) %>% 
  count() %>% 
  rename(n_lwa = n)%>% 
  filter(time == "md") %>% 
  select(-time)

counts_paired <- merge(lwa_counts_paired, lwc_counts_paired, 
                by = c("week", "time")) %>% 
  mutate(paired_or_all = "paired", 
         time = "measured both") 

counts_all <- bind_rows(counts_paired, 
                        counts) %>% 
  select(-paired_or_all) %>% 
  arrange(week)

write.csv(counts_all, here("processed-data", 
               "counts.csv"))
```


Whats up with week 17? 

```{r, warning=F}
analysis_df %>% 
  filter(week == '17', 
         site %in% c("LL"), 
         tree %in% c(2378, 2370, 2382, 2379, 2010)
        ) %>% 
  mutate(tree_week = paste(tree, week, sep = "_")
  ) %>% 
  mutate(water_potential = water_potential) %>% 
  ggplot(aes(y = water_potential, 
             x = -1*lwa_g_cm2, 
             color =    as.factor(tree)
             #shape = as.factor(site)
             )
         ) +
    geom_point(aes(shape = time)) +
  geom_smooth(method = "lm") +
    facet_wrap(~site)

bad_df <- analysis_df %>% 
  filter(week == '17', 
         site %in% c("LL"), 
         tree %in% c(2378, 2370, 2382, 2379, 2010)
        ) 

analysis_df %>% 
  filter(week == '17', 
        # site %in% c("LL"), 
        # tree %in% c(2378, 2370, 2382, 2379, 2010)
        ) %>% 
  mutate(tree_week = paste(tree, week, sep = "_")
  ) %>% 
  mutate(water_potential = water_potential) %>% 
  ggplot(aes(y = lwc_mean, 
             x = -1*lwa_g_cm2, 
             color =    as.factor(tree)
             #shape = as.factor(site)
             )
         ) +
    geom_point(aes(shape = time)
               ) +
  geom_smooth(method = "lm")
```

```{r}
analysis_df %>% 
  ggplot(aes(y = lma_g_cm2, x = lwc_mean )) +
  geom_point()
```

#---------------------

#Add in CWC: 

Reprossessing happening with new isofit, CWC would not change much probably; 
polygons, shade: get rid lof least bright pixels
```{r}
datver_cwc <- "20231128" #Just change this in the 1_combined_processing.Rmd
dataversion_cwc <- paste0("Data_", datver_cwc)

cwc_raw <- read_csv(here(dataversion_cwc,"cwc_alldates.csv"), show_col_types = F) %>% 
  clean_names() %>%
  pivot_longer(cols = c(5:17),
    names_to = "date_x", 
               values_to = "cwc") %>% 
  mutate(date = gsub("x", "", date_x, fixed = TRUE),
         date = mdy(date), 
          week = week(date), 
         tree = as.character(comment)
         ) %>% 
 # select() %>% 
  group_by(tree, week) %>% 
  mutate(cwc = mean(cwc)) %>% 
  rename(week_cwc_link = week) %>% 
  filter(cwc > -100) %>% 
  select(-site, -species, - date_x, -comment, -source)%>% 
  mutate(week_cwc_link = case_when( #dates of overflight and water potential
    date %in% c("2022-02-24", "2022-02-28") ~ "1",
    date %in% c("2022-03-08", "2022-03-03") ~ "2",
    date %in% c("2022-03-16", "2022-03-15") ~ "3",
    date %in% c("2022-03-22", "2022-03-23", "2022-03-25") ~ "4",
    date %in% c("2022-04-05", "2022-04-04", "2022-04-06") ~ "5",
    date %in% c("2022-04-12", "2022-04-11", "2022-04-13") ~ "6",
    date %in% c("2022-04-29", "2022-04-25", "2022-04-27") ~ "7",
    date %in% c("2022-05-03", "2022-05-04") ~ "8",
    date %in% c("2022-05-11", "2022-05-09") ~ "9",
    date %in% c("2022-05-17", "2022-05-23", "2022-05-29") ~ "10",
    date %in% c("2022-09-14", "2022-09-15") ~ "11", 
    date %in% c("2022-08-18", "2022-07-19") ~ "extra"
  )) %>% 
  mutate(date_shift = date)

unique(cwc_raw$week_cwc_link)
unique(analysis_df$week)
unique(analysis_df$date_wp)
```
```{r}
cwc_raw %>% 
  ggplot(aes(y = cwc, 
             x = date, 
             color = as.factor(date))) +
  geom_point()


analysis_df %>% 
  ggplot(aes(y = water_potential, 
             x = date_wp, 
             color = as.factor(date_wp))) +
  geom_point()

```


```{r}
cwc_lwc_raw <- analysis_df %>% 
  mutate(week_cwc_link = case_when( #so that the weeks of overflights overlap with the weeks of sample collection
    week %in% c(8, 9) ~ 9, 
    week %in% c(14, 13) ~ 14, 
    #week %in% c(17) ~ 16, 
    week %in% c(21) ~ 20,
    TRUE ~ as.numeric(week)
  )) %>% 
  mutate(date = date_wp) %>% 
  mutate(week_cwc_link = case_when( #dates of overflight and water potential
    date %in% c("2022-02-24", "2022-02-28") ~ "1",
    date %in% c("2022-03-08", "2022-03-03") ~ "2",
    date %in% c("2022-03-16", "2022-03-15") ~ "3",
    date %in% c("2022-03-22", "2022-03-23", "2022-03-25") ~ "4",
    date %in% c("2022-04-05", "2022-04-04", "2022-04-06") ~ "5",
    date %in% c("2022-04-12", "2022-04-11", "2022-04-13") ~ "6",
    date %in% c("2022-04-29", "2022-04-25", "2022-04-27") ~ "7",
    date %in% c("2022-05-03", "2022-05-04") ~ "8",
    date %in% c("2022-05-11", "2022-05-09") ~ "9",
    date %in% c("2022-05-17", "2022-05-23", "2022-05-29") ~ "10",
    date %in% c("2022-09-14", "2022-09-15") ~ "11", 
    date %in% c("2022-08-18", "2022-07-19") ~ "extra"
  )) %>% 
  select(-date)

#Combine: 
unique(cwc_raw$week_cwc_link) #cwc weeks
unique(cwc_raw$date) #cwc weeks
unique(cwc_lwc_raw$week_cwc_link) #other physiology weeks
unique(cwc_lwc_raw$date_wp)

cwc_lwc_all_df <- merge(cwc_raw, cwc_lwc_raw, by = c("tree", "week_cwc_link"), all = T) %>% 
  distinct() %>% 
  #drop_na(site, species) %>% 
 # select(-shift_id, -la_tree_id) %>% 
   mutate(
     #alas_mean = mean(alas_cm2_per_mm2, na.rm = T),
  #        sla_mean = mean(sla_cm_g,na.rm = T), 
  #        lma_mean = mean(lma_g_cm2,na.rm = T),
  #        lwa_mean = mean(lwa_g_cm2,na.rm = T),
  #        leaf_count_mean = mean(leaf_count, na.rm = T),
         #leaf_area_mean = mean(area_cm2, na.rm = T), 
         #ldmc_mean = mean(ldmc, na.rm = T),
   ) %>% 
    #rename(date_shift = date) %>% 
   distinct() %>% 
  #drop_na(time) %>% 
  ungroup() #%>% 
  # group_by(tree, week, time, type) %>% 
  # mutate(rwc_percent = case_when(
  #   rwc_lfm_percent == NA ~ mean(c(rwc_lfm_percent, rwc_lwc_percent, na.rm = T)),
  #   rwc_lwc_percent == NA ~ mean(c(rwc_lfm_percent, rwc_lwc_percent, na.rm = T)),
  #   rwc_lfm_percent > 0 ~ mean(c(rwc_lfm_percent, rwc_lwc_percent, na.rm = T)), 
  #   TRUE~ as.numeric(rwc_lwc_percent)
  # ))

cwc_analysis_df <-  cwc_lwc_all_df %>% 
   select(tree, site, species, week, 
          #lat, 
          #lon, 
          time, date_shift, date_wp, cwc, lwc_mean, lma_g_cm2, alas_cm2_per_mm2, lwa_g_cm2, leaf_count, week_cwc_link, water_potential, time_season) %>%
   distinct() %>% 
  mutate(week = week(date_shift))%>% 
  group_by(tree, week) %>% 
  mutate(cwc = mean(cwc)) %>% 
  ungroup() %>% 
  select(-time_season) %>% 
   mutate(time_season = case_when(
    week < 17 ~ "before leafout", 
    week >= 17 ~ "after leafout", 
    TRUE ~ as.character("none")
  )) 

write.csv(cwc_analysis_df, here("processed-data", paste0("cwc_analysis",datver,".csv"))) 
```

For Jean: 
```{r}
jean_df <- cwc_analysis_df %>% 
  select(tree, species, time, date_shift, date_wp, cwc, lwc_mean, lma_g_cm2, lwa_g_cm2, water_potential) %>% 
  group_by(tree) %>% 
  fill(c(species), .direction = "downup")

write.csv(jean_df, here("processed-data", "jean_lwa.csv")) 
```

#---------

#Add in LFM: 

#####LFM + RWC + ALAS + WC + WP

LFM is split into different into different categories: stem vs. leaves (type column), and y1 vs. y0 (year column)

plsr: 20% randome holdout, k=fold cross validation

```{r}
lfm_df_all <- read_csv(here("processed-data", paste0("lfm_alldates_",datver,".csv"))) 

lfm_rwc_alas_wp_wc_df <- merge(wp_wc_rwc_alas_df, lfm_df_all, by = c("tree", "week", "time", "type", "year"), 
                               all = T) %>% 
  filter(tree > 100) %>% 
  distinct()  %>% 
  dplyr::group_by(tree, time, week) %>%
  fill(c(date_wp, mpa_mean, lwc_mean), .direction = "downup") %>%
  dplyr::ungroup() %>% 
  group_by(tree) %>% 
  fill(c(species, site, plot), .direction = "downup") %>% 
  ungroup() %>% 
  mutate(rwc_lfm_percent = ((lfm_wet_wt_g-lfm_dry_wt_g)/lfm_dry_wt_g)/mean_swc_per_dry_g * 100,
         rwc_lwc_percent = ((lwc_mean/mean_swc_per_dry_g)*100)) %>% 
  mutate(rwc_lwc_percent = case_when(
    type %in% c("stem") ~ NA_real_, 
    TRUE ~ as.numeric(rwc_lwc_percent))) %>% 
  distinct() %>% 
  # filter(lfm_percent < 200, 
  #        lfm_percent > 0) %>% 
  rename(type_lfm = type) %>% 
 # filter(!(type_lfm == "stem")) %>% 
  distinct() %>% 
  mutate(ilfm = 1/(lfm_percent/100)) %>% 
  filter(ilfm < 2.5,
         ilfm > 0)
  #filter(!is.na(rwc_lwc_percent))
```

#*FINAL (NEW): write.csv

```{r}
lfm_rwc_alas_wp_wc_leaves_df <- lfm_rwc_alas_wp_wc_df %>% 
  filter(!type_lfm == "stem")
  
write.csv(lfm_rwc_alas_wp_wc_leaves_df, here("processed-data", paste0("lfm_rwc_alas_wp_wc_df",datver,".csv")))
```

#LFM dataset (Pepperwood)

```{r}
lfm_mpa_df <- lfm_rwc_alas_wp_wc_df %>% 
  group_by(tree, date_lfm, type_lfm, time) %>% 
  mutate(lfm_percent = mean(lfm_percent, na.rm = T)) %>% 
  mutate(ilfm = 1/(lfm_percent/100)) %>% 
  select(tree, week,  date_lfm, time, time, type_lfm, plot, site, species, mpa_mean, lfm_percent, ilfm) %>% 
  drop_na(species) %>% 
  filter(type_lfm == "leaf") %>% 
  distinct() %>% 
  mutate(date_lfm = ymd(date_lfm))

lfm_mpa_df %>% 
  ggplot(aes(y = lfm_percent, 
             x = date_lfm)) +
  geom_point() +
  scale_x_date(breaks = "month")

n_week <- lfm_mpa_df %>% 
  filter(time == "md") %>% 
  mutate(week = week(date_lfm)) %>% 
  group_by(week, species) %>% 
  mutate(n = n()) %>% 
  select(n, species, week) %>% 
  distinct()

unique(lfm_mpa_df$date_lfm)

write.csv(lfm_mpa_df, here("processed-data", paste0("sedgwick_22_lfm_mpa_df",datver,".csv")))
```


```{r}
lfm_mpa_df %>% 
  filter(type_lfm == "leaf") %>% 
  drop_na(species) %>% 
  ggplot(aes(y = ilfm, 
             x = 0-mpa_mean,
             color = species)) +
  geom_point(alpha = .5) +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(~date_lfm)

```


#--------------------------------

#OLD BELOW:

```{r}
# lfm_leaves_y0_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
#   filter(type == "leaf", 
#          year == 0) %>% 
#  mutate(lfm_wet_wt_y0_g = lfm_wet_wt_g, 
#          lfm_wet_per_dry_y0_g = lfm_wet_per_dry_g, 
#          lfm_dry_wt_y0_g = lfm_dry_wt_g, 
#          lfm_y0_percent = lfm_percent, 
#          tree = as.numeric(tree)) %>% 
#   select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)
# 
# 
# lfm_leaves_y1_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
#   filter(type == "leaf", 
#          year == 1) %>% 
#   mutate(lfm_wet_wt_y1_g = lfm_wet_wt_g, 
#          lfm_wet_per_dry_y1_g = lfm_wet_per_dry_g, 
#          lfm_dry_wt_y1_g = lfm_dry_wt_g, 
#          lfm_y1_percent = lfm_percent, 
#          tree = as.numeric(tree)) %>% 
#   select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)
# 
# lfm_both_both_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
#   filter(type == "both",
#          year == 3)  %>% 
#   mutate(lfm_wet_wt_both_g = lfm_wet_wt_g, 
#          lfm_wet_per_dry_both_g = lfm_wet_per_dry_g, 
#          lfm_dry_wt_both_g = lfm_dry_wt_g, 
#          lfm_both_percent = lfm_percent, 
#          tree = as.numeric(tree), 
#          date_lfm_both = date_lfm) %>% 
#   select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)
# 
# #Stems: 
# 
# lfm_stem_y0_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
#   filter(type == "stem", 
#          year == 0) %>% 
#  mutate(lfm_wet_wt_y0_g = lfm_wet_wt_g, 
#          lfm_wet_per_dry_y0_g = lfm_wet_per_dry_g, 
#          lfm_dry_wt_y0_g = lfm_dry_wt_g, 
#          lfm_y0_percent = lfm_percent, 
#          tree = as.numeric(tree)) %>% 
#   select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)
# 
# lfm_stem_y1_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
#   filter(type == "stem",
#          year == 1)%>% 
#   mutate(lfm_wet_wt_y1_g = lfm_wet_wt_g, 
#          lfm_wet_per_dry_y1_g = lfm_wet_per_dry_g, 
#          lfm_dry_wt_y1_g = lfm_dry_wt_g, 
#          lfm_y1_percent = lfm_percent, 
#          tree = as.numeric(tree)) %>% 
#   select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)
# 
# lfm_stem_both_df <- read.csv( here("processed-data", paste0("lfm_alldates_",datver,".csv"))) %>% 
#   filter(type == "both",
#          year == 1)  %>% 
#   mutate(lfm_wet_wt_both_g = lfm_wet_wt_g, 
#          lfm_wet_per_dry_both_g = lfm_wet_per_dry_g, 
#          lfm_dry_wt_both_g = lfm_dry_wt_g, 
#          lfm_both_percent = lfm_percent, 
#          tree = as.numeric(tree), 
#          date_lfm_both = date_lfm) %>% 
#   select(-year, -lfm_wet_wt_g, -lfm_dry_wt_g, -lfm_percent, -lfm_wet_per_dry_g)
# 
# 
# #combine: 
# lfm_leaves_df <- merge(lfm_leaves_y0_df, lfm_leaves_y1_df, 
#                        by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
#   distinct() 
# 
# lfm_leaves_both_df <- merge(lfm_leaves_df, lfm_both_both_df,
#                             by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
#   distinct() 
# 
# 
# #stems
# lfm_stem_df <- merge(lfm_stem_y0_df, lfm_stem_y1_df, 
#                        by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
#   distinct() 
# 
# lfm_stem_both_df <- merge(lfm_stem_df, lfm_stem_both_df,
#                             by = c("tree", "time", "date_lfm", "week", "type"), all = T) %>% 
#   distinct()
# 
# ```
# 
# #####LFM + RWC + WC + WP (wide):
# 
# ######RWC calc.
# 
# (percent lwc of saturated wc):
# 
# ```{r}
# wp_wc_rwc_lfm_df_wide_leaves <- merge(wp_wc_rwc_df, lfm_leaves_both_df, 
#                                by = c("tree", "week", "time"), 
#                                all = T) %>% 
#   distinct() 
# 
# #stem:
# wp_wc_rwc_lfm_df_wide_stem <- merge(wp_wc_rwc_df, lfm_stem_both_df, 
#                                by = c("tree", "week", "time"), 
#                                all = T) %>% 
#   distinct() 
# 
# #make a shorter name because the long one will be a pain to write out!
# all_water_df <- bind_rows(wp_wc_rwc_lfm_df_wide_leaves, wp_wc_rwc_lfm_df_wide_stem) %>% 
#   mutate(rwc_percent = ((lwc_mean/mean_swc_per_dry_g)*100), 
#         # rwc_percent_y1 = ((lwc_mean/mean_swc_per_dry_g_y1)*100),
#          ) %>% 
#   filter(!species %in% c("leaf")) %>% 
#   distinct()
# ```
# 
# ###AL:AS, add to LFM + RWC + WC + WP: 
# 
# ```{r}
# alas_all_water_df <- merge(all_water_df, alas_df, by = c("week", "tree"), all = T) %>% 
#   mutate(lwa_g_cm2 = lwc_mean * lma_g_cm2)
# ```
# 
# ```{r}
# all_water_df_alas <- alas_all_water_df %>% 
#   select(week, tree, time, plot, site, species, mpa_mean, lwc_mean, type, mean_swc_per_dry_g, mean_swc_g, lfm_y0_percent, lfm_y1_percent, lfm_both_percent, rwc_percent, lwm_g, ldm_g, area_cm2, lma_g_cm2, alas_cm2_per_mm2, leaf_count, sla_cm_g, lwa_g_cm2, date_wp) %>% 
#   distinct() %>% 
#   filter(tree > 1000)
# ```
# 
# #FINAL (OLD): write.csv
# 
# ```{r}
# write.csv(all_water_df_alas, here("processed-data", paste0("LWC_LFM_WP_dates",datver,".csv")))
# ```
# 
# #For Sedgwick dataset: 
# 
# ```{r}
# #what we have from processing above: 
# sedgwick <- all_water_df_alas %>% 
#   select(-lwm_g, -ldm_g, -area_cm2) %>% 
#   group_by(tree, date_wp, time) %>% 
#   mutate(date = date_wp, 
#          lfm_y0_percent = mean(lfm_y0_percent, na.rm = T),
#          lfm_y1_percent = mean(lfm_y1_percent, na.rm = T),
#          lfm_both_percent = mean(lfm_both_percent, na.rm = T),
#          rwc_y0_percent = mean(rwc_percent_y0, na.rm = T),
#          rwc_y0_percent = mean(rwc_percent_y0, na.rm = T),
#         #  lwa_g_cm2 = mean( lwa_g_cm2, na.rm = T),
#          # sla_cm_g = mean( sla_cm_g, na.rm = T),
#         #  alas_cm2_per_mm2 = mean(alas_cm2_per_mm2, na.rm = T),
#         # lma_g_cm2 = mean(lma_g_cm2, na.rm = T), 
#          ) %>% 
# #  distinct() %>% 
#   ungroup() %>% 
#   select(-rwc_percent_y0, -date_wp) %>% 
#   select(date, week, tree, time, plot, site, species, 7:20) %>% 
#   drop_na(time) %>% 
#   distinct()
# 
# write.csv(sedgwick, here("processed-data", paste0("SHIFT_summary",datver,".csv")))
# ```
# 
# ```{r}
# sedgwick %>% 
#   filter(sla_cm_g < 200) %>% 
#   filter(lma_g_cm2 < 0.05, 
#          time == "md") %>% 
#   ggplot(aes(y=leaf_count, x = lma_g_cm2, color = species))+
#   geom_jitter(alpha = .5) +
#   geom_smooth(method = "lm")
# ```
# 
# 
# for Anna's student: 
# ```{r}
# # lfm_mpa_only <- all_water_df %>% 
# #   select(tree, plot, site, species, date_lfm, date_wp, week, time, mpa, type, lfm_y0_percent, lfm_y1_percent, lfm_wet_wt_y0_g, lfm_wet_wt_y1_g, lfm_dry_wt_y0_g, lfm_dry_wt_y1_g, lfm_both_percent, lfm_wet_wt_both_g, lfm_dry_wt_both_g) %>% 
# #   drop_na(date_lfm) %>% 
# #   distinct()
# # 
# # write.csv(lfm_mpa_only, here("processed-data", paste0("lfm_mpa_shift_",datver,".csv")))
# ```
# 
# NOTE: This just includes leaves, need to make another df or add stems eventually.
# 
# ```{r}
# all_water_df %>% 
#   filter(#year %in% c(0,1), 
#          mean_swc_per_dry_g_y0 < 5, 
#          #swc_percent < 300, 
#          species == "blue oak") %>% 
#   ggplot(aes(y = mean_swc_per_dry_g_y0, 
#              x = as.factor(week), 
#             # color = as.factor(type)
#              )) +
#   geom_boxplot() +
#   #facet_wrap(~year) +
#   labs(x = "Week", 
#        y = "SWC (g water/g dry)", 
#        color = "Type") +
#   color_two
# 
# all_water_df %>% 
#   filter(#year %in% c(0,1), 
#          mean_swc_per_dry_g_y0 < 5, 
#          #swc_percent < 300, 
#         # species == "blue oak"
#          ) %>% 
#   ggplot(aes(y = mean_swc_per_dry_g_y0, 
#              x = as.factor(week), 
#             color = as.factor(species)
#              )) +
#   geom_boxplot() +
#   #facet_wrap(~year) +
#   labs(x = "Week", 
#        y = "SWC (g water/g dry)", 
#        color = "Species", 
#        title = "Leaves, Y0") +
#   color_two 
# ```
# 
# ######Missings: 
# 
# ```{r, echo=F}
# #wp_wc_rwc_lfm_df_wide_trees_leaves %>%
#   all_water_df %>% 
#  # filter(species == "blue oak") %>% 
#   select(week, time, tree, lwc_mean, species) %>% 
#   distinct() %>% 
#   drop_na(lwc_mean) %>% 
#   group_by(week, time, species) %>% 
#   count() %>% 
#   ggplot(aes(x = week, y = n, fill = time)) +
#   #facet_wrap(~ species) +
#   geom_col(stat = "identity") + 
#   scale_x_continuous(breaks = seq(9, 40, by = 1)) +
#   labs(title = "LWC")
# ```
# 
# Need to find lwcs:
# 
# - week 9 (2022 - 02-28),
#     -  specifically: tree 2085, 2086, 2087, 2088, 2090, 2348, 2349, 2361
# - week 12 (2022-03-25), some middays
# - week 15 (2022-04-13), trees: 2369, 2377
# - week 17, tree 2383 MD,
# - week 18, (2022-04-05), tree 2343 pd, 2346 pd, 2347 pd,  2365 pd, 2367 pd, 2369 pd, (all pds?)
# - week 21 (20022-05-23) tree 2025 md, tree 2027 md, 2354 md
# - week 29 (2022-07-19) tree 2020 pd, 2030 pd, 2376 pd, 2379 pd, 
# - week 33 (2022-08-18) all (still need to be entered?)
# - week 37 (2022-09-12 and later) many (still need to be entered?)
# 
# ```{r, echo=F}
# all_water_df %>% 
#   select(week, time, tree, mpa_mean, species) %>% 
#   unique() %>% 
#   drop_na(mpa_mean) %>% 
#   group_by(week, time, species) %>% 
#   count() %>% 
#   ggplot(aes(x = week, y = n, fill = time)) +
#  # facet_wrap(~ species) +
#   geom_col(#stat = "identity"
#     ) + 
#   scale_x_continuous(breaks = seq(9, 40, by = 1)) +
#   labs(title = "MPa")
# ```
# ```{r}
# # all_water_df_new <- all_water_df %>% 
# #   select(tree, plot, site, species, week, time, lwc_mean, mpa_mean) %>% 
# #   distinct()
# ```
# 
# Q: What are we missing??? 
# 
# A: A lot....but where??
# 
# (This is each date we collected the associated metric, so if NA in that cell then we don't have it)
# 
# ```{r}
# # missings_df <- all_water_df %>% 
# #   select(tree, week, species, site, plot, time, date_wp, date_wc, 
# #         # date_lfm, 
# #          date_rwc
# #          ) %>% 
# #   filter(if_any(c(date_wp, 
# #                   date_wc, 
# #                  # date_lfm
# #                   ), ~ is.na(.))) %>% 
# #   distinct()
# # 
# # write.csv(missings_df, here("processed-data", paste0("missing_LWC_LFM_WP_dates",datver,".csv")))
# ```
# 
# #####Outliers: 
# 
# 10/26 - started this but need to confirm how we actually want to deal with outliers before moving ahead.
# 
# ```{r}
# # outs_lwc <- all_water_df %>% 
# #   group_by(species, week) %>% 
# #   identify_outliers(lwc_leaf)
# # 
# # outs_lwc_mpa <- all_water_df %>% 
# #   group_by(species, week, time) %>% 
# #   identify_outliers(mpa)
# # 
# # outs_lfm <- all_water_df %>% 
# #   group_by(species, week, time) %>% 
# #   identify_outliers(lfm_y0_percent)
# 
# # without outliers: (something like this...)
# # df %>% 
# #   anti_join(outs, by = c("tree", "week")) %>% 
# #   view()
```

#---------------
#Visualize!

####Water content dynamics: 

Bulk vs. individual leaf LWC...they should probably be the same? 

#####Leaf water content:

```{r}
# all_water_df %>% 
#   ggplot(aes(x = lwc_leaf,
#              y = lwc_bulk, 
#              color = species, 
#              size = week)) +
#   geom_jitter(alpha = .5) +
#   geom_abline() +
#   ylim(-1, 3) +
#   xlim(0, 3) +
#   color_two +
#   facet_wrap(~species) +
#   labs(caption = "black line is 1:1")
```


```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   ggplot(aes(y = -1*mpa, 
#              x = lwc_mean, 
#              #color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .6, 
#               aes(color = week)) +
#   geom_smooth(method = "lm", 
#               aes(group = week, 
#                   color = week)) +
#   facet_wrap(~species)+
#   labs(x = "LWC (g water/gram dry)", 
#        y = "MPa", 
#        color = "Week") 
```

```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~species)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week") +
#   color_grad
# ```
# ```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          week > 15
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~species)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week") +
#   color_grad
```

```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          species == "blue oak"
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   drop_na(site) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~site)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week", 
#        title = "blue oak") +
#   color_grad
```


```{r}
# all_water_df %>% 
#     filter(lwc_mean < 4, 
#          lwc_mean > 0,
#          species == "live oak"
#          #lfm_percent > 20, 
#   #        lfm_percent < 300) %>% 
#   ) %>% 
#   drop_na(site) %>% 
#   ggplot(aes(x = -1*mpa_mean, 
#              y = lwc_mean, 
#              color = week 
#              #size = week
#              )) +
#   geom_jitter(alpha = .5) +
#   facet_wrap(~site)+
#   labs(y = "LWC (g water/gram dry)", 
#        x = "MPa", 
#        color = "Week", 
#        title = "live oak") +
#   # color_grad
```

#####Relative water content: 

Reminder: RWC is combination of LWC and SWC, where:

SWC = g water/g dry after 2 hour rehydration (mean per tree/time of day/week)
LWC = g water/g dry (mean per tree/time of day/week)

RWC x LWC: 

```{r}
# all_water_df %>% 
#    filter(lwc_mean < 5,
#           mean_swc_per_dry_g_y0 < 5) %>% 
#   ggplot(aes(y = lwc_mean, 
#              x = mean_swc_per_dry_g_y0, 
#              color = week 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~species)+
#   labs(x = "Saturated Leaf Water Content", 
#        y = "Field Leaf Water Content", 
#        caption = "black line is 1:1") +
#   color_grad +
#   geom_abline()
```

```{r}
# all_water_df %>% 
#    filter(lwc_mean < 5,
#           mean_swc_per_dry_g_y0 < 5) %>% 
#   ggplot(aes(y = mpa_mean, 
#              x = mean_swc_per_dry_g_y0, 
#              color = week 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~species)+
#   labs(x = "Saturated Leaf Water Content", 
#        y = "MPa", 
#        #caption = "black line is 1:1"
#        ) +
#   color_grad 
```

```{r}
# all_water_df %>% 
#   filter(rwc_percent_y0 > 0, 
#          rwc_percent_y0 < 300) %>% 
#   ggplot(aes(y = lwc_mean * 100, 
#              x =rwc_percent_y0, 
#              color = week 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~species)+
#   labs(x = "RWC (% of saturated)", 
#        y = "LWC (% of dry)", 
#        caption = "black line is 1:1") +
#   color_grad +
#   geom_abline()
```

RWC vs. MPa

```{r}
# all_water_df %>% 
#    filter(rwc_percent_y0 > 0, 
#           rwc_percent_y0 < 300) %>% 
#   ggplot(aes(y = -1*mpa, 
#              x = rwc_percent_y0, 
#              color = as.factor(week)
#              #size = week
#              )) +
#   geom_jitter() +
#   facet_wrap(~species)+
#   labs(x = "Relative Water Content", 
#        y = "MPa") +
#   color_many
```

```{r}
# all_water_df %>% 
#    filter(rwc_percent_y0 > 0, 
#           rwc_percent_y0 < 300) %>% 
#   ggplot(aes(y = -1*mpa_mean, 
#              x = rwc_percent_y0, 
#              color = interaction(species,time) 
#              #size = week
#              )) +
#   geom_point(alpha = .6) +
#   facet_wrap(~interaction(species, time))+
#   labs(x = "Relative Water Content", 
#        y = "MPa") +
#   color_many
```
Q: What are the RWCs important for phsyiological thresholds? 

#####LFM: 

LFM x MPa, year 0

```{r}
# all_water_df %>% 
#   filter(lfm_y0_percent > 20, 
#          lfm_y0_percent < 300) %>% 
#   ggplot(aes(y = -1*mpa_mean, 
#              x = lfm_y0_percent, 
#              color = week)) +
#   geom_jitter(alpha = .6) +
#   facet_wrap(~species) +
#   color_grad +
#   labs(y = "MPa", 
#        x = "LFM, Y0")
```

LFM x MPa, year 1

```{r}
# all_water_df %>% 
#   filter(lfm_y1_percent > 20, 
#          lfm_y1_percent < 300) %>% 
#   ggplot(aes(y = -1*mpa, 
#              x = lfm_y1_percent, 
#              color = species)) +
#   geom_point() +
#   color_two +
#   labs(y = "MPa", 
#        x = "LFM, Y1")
```

LFM year 1 vs. year 0

```{r}
# all_water_df %>% 
#   filter(lfm_y1_percent > 20, 
#          lfm_y1_percent < 300,
#          lfm_y0_percent > 20, 
#          lfm_y0_percent < 300)  %>% 
#   ggplot(aes(y = lfm_y0_percent, 
#              x = lfm_y1_percent, 
#              color = species, 
#              size = week)) +
#   facet_wrap(~species) +
#   geom_jitter(alpha = .6) + 
#   geom_abline() +
#   color_two
```

RWC boxplots: 

```{r}
# rwc_df_spp %>% 
#   filter(species == "blue oak", 
#          year == 0) %>% 
#   filter(year %in% c(0,1), 
#          swc_per_dry_g < 5, 
#          swc_percent < 300) %>% 
#   ggplot(aes(y = swc_per_dry_g, 
#              x = as.factor(week), 
#              color = as.factor(type), 
#              #fill = species
#              )) +
#   geom_boxplot() +
#   #facet_wrap(~year, scales = "free") +
#   labs(x = "Week", 
#        y = "SWC (g water/g dry)", 
#        color = "Type") +
#   color_two
# 
# 
# rwc_df_spp %>% 
#   filter(species == "blue oak", 
#          year == 0, 
#          type == "leaf") %>% 
#   filter(year %in% c(0,1), 
#          swc_per_dry_g < 5, 
#          swc_percent < 300) %>% 
#   ggplot(aes(y = swc_per_dry_g, 
#              x = as.factor(week), 
#              color = as.factor(type), 
#              #fill = species
#              )) +
#   geom_boxplot() +
#   #facet_wrap(~year, scales = "free") +
#   labs(x = "Week", 
#        y = "SWC (g water/g dry)", 
#        color = "Type") +
#   color_two
# ```

#---------------

#Ongoing issues: 

```{r, echo=F}
# all_water_df %>% 
#   #select(week, time, tree, water_potential, lwc, date) %>% 
#  # unique() %>% 
#   group_by(date_wp, time, species) %>% 
#   count() %>% 
#   ggplot(aes(x = date_wp, y = n, fill = time)) +
#   facet_wrap(~species)+
#   geom_col(stat = "identity") 
```

```{r, echo=F}
# all_water_df %>% 
#   #select(week, time, tree, water_potential, lwc, date) %>% 
#  # unique() %>% 
#   group_by(date_wc, time, species) %>% 
#   count() %>% 
#   ggplot(aes(x = date_wc, y = n, fill = time)) +
#   facet_wrap(~species)+
#   geom_col(stat = "identity") 
```
- water potentials for week 17 piney, cucu, and chamise are missing? (04.25.2022 and 04.27.2022) We have LFM and LWC for this week from those sites however.  

- missing LFM from week 18 (05.04.2022)

- Predawns from early may, middays from end of March are missing (?)













