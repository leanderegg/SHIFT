---
title: "Adding in CWC from Phil analysis!"
author: "Indra Boving"
date: "3/14/2023"
output: html_document
---

##setup
```{r setup, include=FALSE}
#install.packages("MuMIn")
#devtools::install_github("an-bui/calecopal")
library(data.table)
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
library(gridExtra)
library(calecopal)
library(rstatix)
library(vars)
library(MuMIn)
library(lme4) #for mixed effects models
library(cowplot)
#install.packages("ggcorrplot")
library(ggcorrplot)
select = dplyr::select
library('variancePartition')
source(here::here("scripts", "scripts_functions", "plotPercentBars_IB.R"))
source(here::here("scripts", "scripts_functions", "figure_info.R"))

datver_cwc <- "05042022" #Just change this in the 1_combined_processing.Rmd
dataversion_cwc <- paste0("Data_", datver_cwc)
```

```{r}
cwc_raw <- read_csv(here(dataversion_cwc,"cwc-alldates.csv"), show_col_types = F) %>% 
  clean_names() %>% 
  mutate(tree = la_tree_id) %>% 
  pivot_longer(cols = (6:17),
              names_to = "date", 
               values_to = "cwc") %>% 
  mutate(date = gsub("x", "", date, fixed = TRUE), 
         date = ymd(date), 
         week = week(date), 
         tree = as.character(tree)) %>% 
  group_by(tree, week) %>% 
  mutate(cwc = mean(cwc))

cwc_lwc_raw <- read_csv(here("processed-data", paste0("lfm_rwc_alas_wp_wc_df",datver,".csv")), show_col_types = F) %>% 
  filter(type == "leaf",
         !week == 9, 
         time == 'md') %>% 
  mutate(time_season = case_when(
    week <= 17 ~ "before leafout", 
    week > 17 ~ "after leafout", 
    TRUE ~ as.character("none")
  )) %>% 
  mutate(water_potential = -1*mpa_mean) 

#Combine: 
unique(cwc_raw$week)
unique(cwc_lwc_df$week)
unique(cwc_raw$tree)
unique(cwc_lwc_df$tree)

cwc_lwc_df <- merge(cwc_raw, cwc_lwc_raw, by = c("tree", "week"), all = T) %>% 
  distinct() %>% 
  filter(cwc > -100)
```


#Initial viz:

```{r}
mpa_cwc <- cwc_lwc_df %>% 
  ggplot(aes(y = mpa_mean, x = cwc, color = as.factor(week))) +
  geom_point() +
  theme(legend.position = "none") +
  geom_smooth(method = "lm", se = F)

lwc_cwc <- cwc_lwc_df %>% 
  ggplot(aes(y = lwc_mean, x = cwc, color = as.factor(week))) +
  geom_point()+
  theme(legend.position = "none")+
  geom_smooth(method = "lm", se = F)

lwa_cwc <- cwc_lwc_df %>% 
  ggplot(aes(y = lwa_g_cm2, x = cwc, color = as.factor(week))) +
  geom_point()+
  theme(legend.position = "none") +
  geom_smooth(method = "lm", se = F)

lma_cwc <- cwc_lwc_df %>% 
  ggplot(aes(y = lma_g_cm2, x = cwc, color = as.factor(week))) +
  geom_point()+
  theme(legend.position = "none") +
  geom_smooth(method = "lm", se = F)

rwc_cwc <- cwc_lwc_df %>% 
  ggplot(aes(y = rwc_percent, x = cwc, color = as.factor(week))) +
  geom_point()+
  theme(legend.position = "none") +
  geom_smooth(method = "lm", se = F)
rwc_cwc

legend <- cowplot::get_legend(cwc_lwc_df %>% 
  ggplot(aes(y = lma_g_cm2, x = cwc, color = as.factor(week))) +
  geom_point()+
  geom_smooth(method = "lm", se = F))

all_cwc_noleg <- cowplot::plot_grid(mpa_cwc, lwc_cwc, lwa_cwc, lma_cwc, nrow = 2)

all_cwc_plot <- cowplot::plot_grid(all_cwc_noleg, legend, ncol = 2, rel_widths = c(1, .2))

all_cwc_plot
```

```{r}
cwc_lwc_df %>% 
  ggplot(aes(y = mpa_mean, x = cwc, color = as.factor(week)
             )) +
  geom_point() +
  geom_smooth(method = "lm", se = F) 
```


