---
title: "Establishing relationships between LWC and MPa, Part 2"
author: "Indra Boving"
date: "11/9/2022"
output: html_document
---

##setup
```{r setup, include=FALSE}
#install.packages("")
#devtools::install_github("an-bui/calecopal")

library(data.table)
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
library(gridExtra)
library(calecopal)
library(rstatix)
library(vars)
library(MuMIn)
library(lme4) #for mixed effects models
library(arm)

select = dplyr::select

source(here::here("scripts", "figure_info.R"))

datver <- "11082022"
dataversion <- paste0("Data_", datver)
```

```{r, echo=F}
wc_all_raw <- read_csv(here("processed-data", paste0("LWC_LFM_WP_dates",datver,".csv")), show_col_types = FALSE) %>% 
  filter(species == "blue oak")

wc_qudo_df <- wc_all_raw %>% 
   filter(#week > 15, 
         species == "blue oak", 
          lwc_mean < 5, 
         lwc_mean > 0
         ) %>% 
  mutate(lwc = lwc_mean) %>% 
  group_by(tree, week, time) %>% 
  mutate(water_potential = mean(mpa_mean), 
         tree_factor = as.factor(tree)) %>% 
  ungroup() %>% 
  mutate(week = case_when(
    week %in% c(13) ~ 14, 
    TRUE ~ week
  )) %>% 
  select(week, time, lwc, water_potential, rwc_percent,
         tree, tree_factor, plot, site, species, date_wc, date_wp) %>% 
  unique()

wc_lm_df <- wc_qudo_df %>% 
  filter(week > 15)
```

From what weeks do we have the most trees?
```{r, echo=F}
wc_qudo_df %>% 
  select(week, time, tree, lwc) %>% 
  unique() %>% 
  group_by(week, time) %>% 
  count() %>% 
  ggplot(aes(x = week, y = n, fill = time)) +
  geom_col(stat = "identity") + 
  scale_x_continuous(breaks = seq(9, 30, by = 1))
```

```{r, echo=F}
wc_qudo_df %>% 
    select(week, time, tree, water_potential) %>% 
 # unique() %>% 
  group_by(week, time) %>% 
  count() %>% 
  ggplot(aes(x = week, y = n, fill = time)) +
  geom_col(stat = "identity") 
```
A: week 17, 21, 29, 10


#Hydration per week: 

MPa ~ lwc + (lwc|tree) + (1|wk)

```{r}
wc_qudo_df %>% 
  ggplot(aes(y = water_potential, 
             x = lwc, 
             color = as.factor(tree)
             )) +
  geom_point(aes(shape = time)) + 
  geom_smooth(method = "lm",
              se = F) +
  facet_wrap(~week, scales = "free")
  #theme(legend.position = "none") +
```


```{r}
wc_lm_hyd_df <- wc_qudo_df 

for (i in unique(wc_lm_hyd_df$week)) {
  
  df <- wc_lm_hyd_df %>% 
    filter(week == i)
  
  p <- df %>% 
  ggplot(aes(y = water_potential, 
             x = lwc, 
             color = as.factor(tree)
             )) +
  geom_point(aes(shape = time)) + 
  geom_smooth(method = "lm",
              se = F) +
  #theme(legend.position = "none") +
  labs(title = i)
  
  if (!is.null(p)) plot(p)
  
}
```
Okay, now try running the model: 

MPa ~ lwc + (lwc|tree) + (1|wk)

```{r}
wc_qudo_df %>% 
  ggplot(aes(y= water_potential, 
             x = lwc, 
             color = interaction(tree, week), 
             shape = time)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  theme(legend.position = "none")
```

1. 
This give us a random slope and intercept per tree and per week

```{r}
m_wk_rand <- lmer(water_potential ~ lwc + (lwc|tree) + (lwc|week), data = wc_qudo_df)

unique(wc_qudo_df$week)
```

```{r}
grand_slope <- broom.mixed::tidy(m_wk_rand)
grand_slope

ran_list <- ranef(m_wk_rand)

ran_df <- as.data.frame(ran_list[['week']])%>% 
  mutate(estimate = `(Intercept)`, 
         slope = `lwc`, 
         -lwc) %>%
  select(-`(Intercept)`)

ran_err <- arm::se.ranef(m_wk_rand)
ran_err_df <- as.data.frame(ran_err[['week']]) %>% 
  mutate(std.error = `(Intercept)`, 
         std.error.slope = `lwc`)%>% 
  select(-`(Intercept)`, 
         -lwc)

weeks <- data_frame(1:9)
weeks$week <- c(10, 11, 14, 15, 17, 18, 19, 21, 29) 

ran_df_week <- bind_cols(weeks, ran_df, ran_err_df) %>% 
  select(-`1:9`) %>% 
  data_frame()
```

Random slopes of each week: 

```{r}
ran_df_week %>% 
 # filter(week %in% c(14, 17, 21, 29)) %>% 
 # filter(term == "lwc") %>% 
  mutate(upr = slope + (std.error.slope/2), 
         lwr = slope - (std.error.slope/2)) %>% 
  ggplot(aes(color= week)
    ) + 
  geom_point(aes(y = slope ,x = week), size =3) +
    geom_point(aes(y = upr, x = week), size = 1) +
  geom_point(aes(y = lwr, x = week), size = 1) +
  #geom_line(aes(group = week, y = week, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = week, 
                   xend = week, 
                   color = week))+
  labs(x = "Week", 
       color = "week", 
       y = "Slope") +
   # facet_wrap(~y_var_name, scales = "free") + 
theme(
  strip.background = element_blank(),
  strip.text.y = element_blank(), 
  strip.text.x = element_text(size = 18), 
 # axis.text.y = element_blank(), 
  #axis.ticks.y = element_blank(), 
  axis.title = element_text(size = 20), 
  legend.title = element_text(size = 18)
  ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  scale_x_continuous(breaks = seq(9, 30, by = 1)) +
  theme(legend.position = "none")
```

Random intercepts of each week:
```{r}
ran_df_week %>% 
  filter(week %in% c(14, 15, 17, 21, 29)) %>% 
 # filter(term == "lwc") %>% 
  mutate(upr = estimate + (std.error/2), 
         lwr = estimate - (std.error/2)) %>% 
  ggplot(aes(color= week)
    ) + 
  geom_point(aes(y = estimate,x = week), size =3) +
    geom_point(aes(y = upr, x = week), size = 1) +
  geom_point(aes(y = lwr, x = week), size = 1) +
  #geom_line(aes(group = week, y = week, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = week, 
                   xend = week, 
                   color = week))+
  labs(x = "Week", 
       color = "week", 
       y = "Intercept") +
   # facet_wrap(~y_var_name, scales = "free") + 
theme(
  strip.background = element_blank(),
  strip.text.y = element_blank(), 
  strip.text.x = element_text(size = 18), 
 # axis.text.y = element_blank(), 
  #axis.ticks.y = element_blank(), 
  axis.title = element_text(size = 20), 
  legend.title = element_text(size = 18)
  ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  scale_x_continuous(breaks = seq(9, 30, by = 1))
```

######Old attempt using separate model per week:
```{r}
# df_subset_wks <- wc_qudo_df %>% 
#  filter(week %in% c(14, 15, 17, 21, 29))
# 
# for (i in unique(df_subset_wks$week)) {
# 
#    df <- df_subset_wks %>%
#     filter(week == i)
# 
#    m_wk <- lmer(water_potential ~ lwc + (1|tree), data = df)
#    m_wk
# 
#    df2 <- broom.mixed::tidy(m_wk) %>%
#      mutate(week = i) %>%
#      #select(estimate, week, term) %>% 
#      data.frame()
# 
#    assign(paste0("m_df_", i), data.frame(df2))
#    #print(paste0("m_df_", i))
# }
# 
# all_hyd_mods <- bind_rows(#m_df_9, 
#                           #m_df_10,
#                           #m_df_11,
#                           #m_df_12, 
#                          # m_df_13, 
#                           m_df_14, 
#                           m_df_15, 
#                           m_df_17, 
#                          # m_df_18, 
#                          # m_df_19, 
#                           m_df_21, 
#                           m_df_29)
# 
# all_hyd_mods %>% 
#  # filter(week %in% c(14, 15, 17, 21, 29)) %>% 
#   filter(term == "lwc") %>% 
#   mutate(upr = estimate + (std.error/2), 
#          lwr = estimate - (std.error/2)) %>% 
#   ggplot(aes(color= week)
#     ) + 
#   geom_point(aes(y = estimate,x = week), size =3) +
#     geom_point(aes(y = upr, x = week), size = 1) +
#   geom_point(aes(y = lwr, x = week), size = 1) +
#   #geom_line(aes(group = week, y = week, x = upr)) +
#   geom_segment(aes(y= lwr, 
#                    yend = upr, 
#                    x = week, 
#                    xend = week, 
#                    color = week))+
#   labs(x = "Week", 
#        color = "week", 
#        y = "Grand Slope") +
#    # facet_wrap(~y_var_name, scales = "free") + 
# theme(
#   strip.background = element_blank(),
#   strip.text.y = element_blank(), 
#   strip.text.x = element_text(size = 18), 
#  # axis.text.y = element_blank(), 
#   #axis.ticks.y = element_blank(), 
#   axis.title = element_text(size = 20), 
#   legend.title = element_text(size = 18)
#   ) +
#   geom_hline(yintercept = 0, linetype="dotted") + 
#   scale_x_continuous(breaks = seq(9, 30, by = 1))
```

#Space

1. Center by week
2. plot all midday grand slopes

mpa ~ LWCweek + (LWCweek|week) + (1|tree)

```{r}
wc_wk_centered_df <- wc_qudo_df %>% 
  filter(time == "md") %>% 
  group_by(week) %>% 
  mutate(lwc_scaled = scale(lwc)) %>% 
  filter(lwc_scaled < 4)

#not scaled
wc_wk_centered_df %>% 
  #filter(time == "md") %>% 
  ggplot(aes(y = water_potential, 
             x = lwc, 
             #color = tree_factor
             color = as.factor(week)
             )) +
  geom_point(alpha = .3) +
  geom_smooth(method = "lm", se = F) 
#scaled
wc_wk_centered_df %>% 
  ggplot(aes(y = water_potential, 
             x = lwc_scaled, 
             #color = tree_factor
             color = as.factor(week)
             )) +
  geom_point(alpha = .3) +
  geom_smooth(method = "lm", se = F) + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  labs(y= "Midday MPa", 
       x = "LWC (scaled and centered by week)", 
       color = "Week")
```
```{r}
space_mod <- lmer(water_potential ~ lwc_scaled + (lwc_scaled|week) + (1|tree), data = wc_wk_centered_df)
summary(space_mod)

space_mod_df <- broom.mixed::tidy(space_mod)
space_mod_df
```
Across all weeks, there is a consistent relationship between MPa ~ LWC of -0.2602190

#Time

```{r}
wc_qudo_df %>% 
  filter(time == "md") %>% 
  ggplot(aes(y = water_potential, 
             x = lwc, 
             color = as.factor(tree), 
             show.legend = FALSE)) +
  geom_point(aes(size = week))+
  geom_smooth(method = "lm", se = F) +
 # theme(legend.position = "none") +
  labs(x = "LWC", 
       y = "Midday MPa")
```
```{r}
wc_qudo_df %>% 
  filter(time == "pd") %>% 
  ggplot(aes(y = water_potential, 
             x = lwc, 
             color = as.factor(tree), 
             show.legend = FALSE)) +
  geom_point(aes(size = week))+
  geom_smooth(method = "lm", se = F) +
 # theme(legend.position = "none") +
  labs(x = "LWC", 
       y = "Predawn MPa")
```
Make week a fixed effect, since that's what we're interested in: 

#HERE
```{r}
time_mod <- lmer(water_potential ~ lwc + week + (lwc|tree), data = wc_qudo_df)
summary(time_mod)

ran_list <- ranef(time_mod)

tree_eff <- as.data.frame(ran_list[['tree']]) %>% 
  mutate(estimate = `(Intercept)`, 
         slope = `lwc`) %>%
  select(-`(Intercept)`, 
          -lwc)
tree_eff

ran_err_tree <- arm::se.ranef(time_mod)
ran_err_tree <- as.data.frame(ran_err[['tree']]) %>% 
  mutate(std.error = `(Intercept)`, 
         std.error.slope = `lwc`)%>% 
  select(-`(Intercept)`, 
         -lwc)

inds<- data_frame(1:50)
inds$tree <- c(unique(wc_qudo_df$tree))

ran_df_tree <- bind_cols(inds, tree_eff, ran_err_tree) %>% 
  select(-`1:50`) %>% 
  data_frame()

ran_df_tree %>% 
  mutate(tree = as.factor(tree)) %>% 
 # filter(tree %in% c(14, 17, 21, 29)) %>% 
 # filter(term == "lwc") %>% 
  mutate(upr = slope + (std.error.slope/2), 
         lwr = slope - (std.error.slope/2)) %>% 
  ggplot(aes(color= tree)
    ) + 
  geom_point(aes(y = slope ,x = tree), size =3) +
    geom_point(aes(y = upr, x = tree), size = 1) +
  geom_point(aes(y = lwr, x = tree), size = 1) +
  #geom_line(aes(group = tree, y = tree, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = tree, 
                   xend = tree, 
                   color = tree))+
  labs(x = "tree", 
       color = "tree", 
       y = "Slope") +
   # facet_wrap(~y_var_name, scales = "free") + 
theme(
  strip.background = element_blank(),
  strip.text.y = element_blank(), 
  strip.text.x = element_text(size = 18), 
 # axis.text.y = element_blank(), 
  #axis.ticks.y = element_blank(), 
  axis.title = element_text(size = 20), 
  legend.title = element_text(size = 18)
  ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
 # scale_x_continuous(breaks = seq(9, 30, by = 1)) +
  theme(legend.position = "none")
```

