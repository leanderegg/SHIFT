---
title: "Establishing relationships between LWC and MPa, Part 3"
author: "Indra Boving"
date: "11/9/2022"
output: html_document
---

##setup
```{r setup, include=FALSE}
#install.packages("")
#devtools::install_github("an-bui/calecopal")

library(data.table)
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
library(gridExtra)
library(calecopal)
library(rstatix)
library(vars)
library(MuMIn)
library(lme4) #for mixed effects models
library(arm)

select = dplyr::select

source(here::here("scripts", "scripts_functions", "figure_info.R"))

#datver <- "20230316"
#dataversion <- paste0("Data_", datver)
```

```{r, echo=F}
rwc_all_raw <- read_csv(here("processed-data", paste0("lfm_rwc_alas_wp_wc_df",datver,".csv")), show_col_types = FALSE) 

unique(rwc_all_raw$type)

rwc_df <- rwc_all_raw %>% 
   filter(
      rwc_lfm_percent < 500,
      rwc_lfm_percent > 0,
          !year == 3
         ) %>% 
  mutate(lwc = lwc_mean) %>% 
  group_by(tree, week, time) %>% 
  mutate(water_potential = mean(mpa_mean)) %>% 
  ungroup() %>% 
  # mutate(week = case_when(
  #   week %in% c(13) ~ 14, 
  #   TRUE ~ week
  # )) %>% 
  select(week, time, lwc, lfm_wet_per_dry_g, water_potential, rwc_lwc_percent, rwc_lfm_percent, year, type, tree, plot, site, species, date_wp, mean_swc_per_dry_g, week_rwc_link) %>% 
  distinct() %>% 
  drop_na(type) %>% 
  mutate(rwc_week = case_when(
    week == week_rwc_link ~ "yes", 
    TRUE ~ as.character("no")
  ))

unique(rwc_df$type)

rwc_long_df <- rwc_df %>% 
  pivot_longer(cols = c(rwc_lfm_percent, rwc_lwc_percent),
               names_to = "collection_type", 
               values_to = "rwc_percent") %>% 
  mutate(collection_type = case_when(
    collection_type %in% c("rwc_lfm_percent") ~ "lfm",
    collection_type  %in% c("rwc_lwc_percent") ~ "lwc",
    TRUE ~ as.character(collection_type)
  )) %>% 
  distinct() %>% 
  filter(!is.na(rwc_percent)) %>% 
  group_by(tree) %>% 
  mutate(max_swc_per_dry_g = max(mean_swc_per_dry_g), 
         rwc_max_percent = (lwc/max_swc_per_dry_g)*100)

unique(rwc_long_df$week_rwc_link)
```

```{r}
yes <- rwc_long_df %>% 
  filter(#year == 0, 
         rwc_week == "yes",
         collection_type == "lwc",
         species == "blue oak", 
         type == "leaf")

rwc_long_df %>% 
  filter(#year == 0, 
         rwc_week == "yes",
         collection_type == "lwc",
         species == "blue oak", 
         type == "leaf") %>% 
ggplot(aes(y = rwc_percent, x = water_potential, color = as.factor(week_rwc_link)
           )) +
  geom_jitter(alpha = .5) +
  facet_wrap(~time) +
  geom_smooth(method = "lm")
```


```{r}
rwc_long_df %>% 
  filter(rwc_percent < 100, 
         species == "blue oak", 
         type == "leaf") %>% 
ggplot(aes(y = rwc_percent, x = date_wp, color = type)) +
  geom_jitter(alpha = .3) +
  facet_wrap(~time)
```

#RWC vs. LWC
```{r, echo=F}
rwc_df  %>% 
  ggplot(aes(y = rwc_lwc_percent, 
             x= lwc, 
             color = species)) +
  geom_point() +
  facet_wrap(~year)
```


```{r, echo=F}
rwc_df  %>% 
  ggplot(aes(y = rwc_lfm_percent, 
             x= lwc, 
             color = as.factor(week), 
             shape = type)) +
  geom_point() +
  facet_wrap(~year)
```
```{r}
rwc_df %>% 
  ggplot(aes(y = rwc_lfm_percent, x = rwc_lwc_percent, color = type)) +
  geom_point() +
  geom_abline()
```


```{r, echo=F}
rwc_df %>% 
 # filter(rwc_percent < 100) %>% 
  ggplot(aes(y = rwc_lwc_percent, 
             x= water_potential, 
             color = species,
             )) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(~time)

rwc_df %>% 
 # filter(rwc_percent < 100) %>% 
  ggplot(aes(y = rwc_lfm_percent, 
             x= water_potential, 
             color = type,
             )) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(~time*species)
```


```{r}
rwc_df %>% 
  filter(species == "blue oak", 
         year == 0) %>% 
  filter(year %in% c(0,1), 
         mean_swc_per_dry_g < 5, 
        # swc_percent < 300
         ) %>% 
  ggplot(aes(y = mean_swc_per_dry_g, 
             x = as.factor(week_rwc_link), 
             color = as.factor(type), 
             #fill = species
             )) +
  geom_boxplot() +
  #facet_wrap(~year, scales = "free") +
  labs(x = "Week", 
       y = "SWC (g water/g dry)", 
       color = "Type") +
  color_two


rwc_df %>% 
  filter(species == "blue oak", 
         year == 0, 
         type == "leaf") %>% 
  filter(year %in% c(0,1), 
         mean_swc_per_dry_g < 5, 
         #swc_percent < 300
         ) %>% 
  ggplot(aes(y = mean_swc_per_dry_g, 
             x = as.factor(week_rwc_link), 
             color = as.factor(type), 
             #fill = species
             )) +
  geom_boxplot() +
  #facet_wrap(~year, scales = "free") +
  labs(x = "Week", 
       y = "SWC (g water/g dry)", 
       color = "Type") +
  color_two
```



