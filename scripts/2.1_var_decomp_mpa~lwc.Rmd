---
title: "Establishing relationships between LWC and MPa"
author: "Indra Boving"
date: "11/8/2022"
output: html_document
---

##setup
```{r setup, include=FALSE}
#install.packages("MuMIn")
#devtools::install_github("an-bui/calecopal")

library(data.table)
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
library(gridExtra)
library(calecopal)
library(rstatix)
library(vars)
library(MuMIn)
library(lme4) #for mixed effects models
library(cowplot)

select = dplyr::select

library('variancePartition')


source(here::here("scripts", "scripts_functions", "plotPercentBars_IB.R"))

source(here::here("scripts", "scripts_functions", "figure_info.R"))



datver <- "20230220"
dataversion <- paste0("Data_", datver)
```


```{r}
wc_all_raw <- read_csv(here("processed-data", paste0("LWC_LFM_WP_dates",datver,".csv")), show_col_types = F) %>%   mutate(lwc_mean = lwc_mean_combined) %>% 
  filter(lwc_mean > 0, 
         lwc_mean < 3)
```

Before leafout: 

```{r}
qudo_wc_all <- wc_all_raw %>% 
  filter( #week > 15, 
         species == "blue oak", 
         lwc_mean < 10) %>% 
  group_by(tree, week, time, lwc_mean) %>% 
  mutate(water_potential = mean(mpa_mean), 
         lwc = lwc_mean) 
```

```{r}
full_nice <- qudo_wc_all %>% 
  ggplot(aes(y = water_potential, 
             x = lwc, 
             color = week)) +
  geom_point() +
 # geom_smooth(method = "lm", 
            #  se = F, 
            #  color = "black") +
  color_grad +
  #color_many +
  labs(y = "", 
       x = "", 
       color = "Week") +
  theme(legend.position = c(0.9, 0.78)) 
full_nice
```

Making models of each variable of interest: 

Use al:as or lma to pick inflection point (currently just using week):

Variance decomposition, build 3-4 models:
LWC ~ null
~time
~mpa
~mpa + time

Look at marginal R^2, decompose add them together, overlap should be greater than sum (since they explain some same)

```{r}
m0 <- lmer(water_potential ~ 1 + (1|tree), data = qudo_wc_all)
m1 <- lmer(water_potential ~ week + (1|tree), data = qudo_wc_all)
m2 <- lmer(water_potential ~ lwc + (1|tree), data = qudo_wc_all)
m3 <- lmer(water_potential ~ week + lwc + (1|tree), data = qudo_wc_all)

#try using r.squaredGLMM:
mods_list <- list(m0, m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1]) #vector of r2s
mods <- c("m0", "m1", "m2", "m3")

mod_all_df1_full <-  data.frame(mods, r2m)

mod_all_df_full <- mod_all_df1_full %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #other_effects =  m3 - week_effect - lwc_effect,
    week_effect = m3 - m2, #week + mpa mod - mpa mod
         lwc_effect = m3 - m1, #week + mpa mod - week mod
         week_lwc_effect = m3, #week + mpa mod 
    other_effects =  m3 - week_effect - lwc_effect,
         ) #full minus the effects of mpa and week alone
mod_all_df_full

#for plotting (maybe?)
mod_all_long_full <- mod_all_df_full %>% 
  select(week_effect, lwc_effect, week_lwc_effect, other_effects) %>% 
  pivot_longer(cols = c(week_effect, lwc_effect, week_lwc_effect, other_effects), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("week_effect", "lwc_effect", "other_effects") ~ "Var. Decomp", 
    effect %in% c("week_lwc_effect") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "Full Date Range")
mod_all_long_full

mod_all_long_full %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill

```

Once leafout finishes, then things get linear: 

- currently just using week approximation, but will use LMA plateau once we have that together:

```{r}
qudo_wc_full <- wc_all_raw %>% 
   filter(#week > 15, 
         species == "blue oak", 
         lwc_mean < 10) %>% 
  group_by(tree, week, time, lwc_mean) %>% 
  mutate(water_potential = mean(mpa_mean), 
         lwc = lwc_mean) %>% 
  mutate(section = "full") %>% 
  select(section, species, week, water_potential, lwc)


qudo_wc_linear <- wc_all_raw %>% 
  filter(week > 16, 
         species == "blue oak", 
         lwc_mean < 10) %>% 
  group_by(tree, week, time, lwc_mean) %>% 
  mutate(water_potential = mean(mpa_mean), 
         lwc = lwc_mean) %>% 
  mutate(section = "linear")%>% 
  select(section, species, week, water_potential, lwc)

qudo_wc_all <- bind_rows(qudo_wc_linear, qudo_wc_full)

nice_all <- qudo_wc_all %>% 
   ggplot(aes(y = water_potential, 
             x = lwc, 
             color = week)) +
  geom_point() +
#  geom_smooth(method = "lm", se = F, color = "black") +
  facet_wrap(~section, scales = "free") +
  color_grad +
  labs(y = "Water Potential", 
       x = "LWC", 
       color = "Week") +
  theme(legend.position = "none") 
nice_all
```


```{r}
lin_nice <- qudo_wc_linear %>% 
  ggplot(aes(y = water_potential, 
             x = lwc, 
             color = week)) +
  geom_point() +
  geom_smooth(method = "lm", 
              se = F, 
              color = "black") +
  color_grad +
  labs(y = "", 
       x = "", 
       color = "Week") +
  theme(legend.position = "none") 
lin_nice
```
#put together:

```{r}
together <- cowplot::plot_grid( full_nice, 
                                lin_nice,
                               ncol = 1, 
                               rel_heights = c(1, 1))
together
```


```{r}
m0 <- lmer(water_potential ~ 1 + (1|tree), data = qudo_wc_linear)
m1 <- lmer(water_potential ~ week + (1|tree), data = qudo_wc_linear)
m2 <- lmer(water_potential ~ lwc + (1|tree), data = qudo_wc_linear)
m3 <- lmer(water_potential ~ week + lwc + (1|tree), data = qudo_wc_linear)

#try using r.squaredGLMM:
mods_list <- list(m0, m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1]) #vector of r2s
mods <- c("m0", "m1", "m2", "m3")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #other_effects =  m3 - week_effect - lwc_effect,
    week_effect = m3 - m2, #week + mpa mod - mpa mod
         lwc_effect = m3 - m1, #week + mpa mod - week mod
         week_lwc_effect = m3, #week + mpa mod
    other_effects =  m3 - week_effect - lwc_effect
         ) #full minus the effects of mpa and week alone

mod_all_df

#for plotting (maybe?)
mod_all_long <- mod_all_df %>% 
  select(week_effect, lwc_effect, week_lwc_effect, other_effects) %>% 
  pivot_longer(cols = c(week_effect, lwc_effect, week_lwc_effect, other_effects), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("week_effect", "lwc_effect", "other_effects") ~ "Var. Decomp", 
    effect %in% c("week_lwc_effect") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout")
mod_all_long

mod_all_long %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```

```{r}
mod_both_df_long <- bind_rows(mod_all_long_full, mod_all_long) %>% 
  filter(!effect %in% c("week_lwc_effect"))

mod_both_df_long %>% 
  ggplot(aes(x = decomp, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Data", 
       fill = "Effect") +
  scale_fill_manual(labels = c("LWC", "LWC & Week", "Week"), 
                    values = met.brewer("Tiepolo"))
```


```{r}
#try using broom::
# m0_df <- broom::glance(m0) %>% mutate(mod = "m0")
# m0_df <- broom::glance(m0) %>% mutate(mod = "m0")
# m1_df <- broom::glance(m1) %>% mutate(mod = "m1")
# m2_df <- broom::glance(m2) %>% mutate(mod = "m2")
# m3_df <- broom::glance(m3) %>% mutate(mod = "m3")
# m0_df
# mod_all_df <- bind_rows(m0_df, m1_df, m2_df, m3_df)
# mod_all_df
# 
# #pull r^2s:
# m0_r2 <- broom.mixed::glance(m0) %>% select(r.squared) %>% pull()
# m1_r2 <- broom.mixed::glance(m1) %>% select(r.squared) %>% pull()
# m2_r2 <- broom.mixed::glance(m2) %>% select(r.squared) %>% pull()
# m3_r2 <- broom.mixed::glance(m3) %>% select(r.squared) %>% pull()
# 
# 
# mod_all_df1 <- mod_all_df %>% 
#   mutate(sum_r2 = sum(mod_all_df$r.squared), 
#          m1 = m1_r2, 
#          m2 = m2_r2, 
#          m3 = m3_r2, 
#          m0 = m0_r2) %>% 
#   select(r.squared, sum_r2, mod, m1, m2, m3, m0) %>% 
#   mutate(week_effect = m3 - m2, #week + mpa mod - mpa mod
#          mpa_effect = m3 - m1, #week + mpa mod - week mod
#          week_mpa_effect = m3, #week + mpa mod 
#          other_effects =  m3 - (m3 - m1) - (m3 - m2)) #full minus the effects of mpa and week alone
# mod_all_df1
# 
# #for plotting (maybe?)
# mod_all_long <- mod_all_df1 %>% 
#   select(week_effect, mpa_effect, week_mpa_effect, other_effects) %>% 
#   pivot_longer(cols = c(week_effect, mpa_effect, week_mpa_effect, other_effects), 
#     names_to = "effect") %>% 
#   distinct() %>% 
#   mutate(analysis = case_when(
#     effect %in% c("week_effect", "mpa_effect", "other_effects") ~ "Var. Decomp", 
#     effect %in% c("sum_r2") ~ "Full Mod.", 
#     TRUE ~ as.character(effect)
#   ))
# mod_all_long
# 
# mod_all_long %>% 
#   ggplot(aes(x = analysis, 
#              y = value, 
#          fill = effect)) +
#   geom_col(stat = "identity") +
#  # geom_text(aes(label = value)) +
#   color_many +
#   labs(y = "R squared", 
#        x = "Predictor") +
#   color_fill
```

