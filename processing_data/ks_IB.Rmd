---
title: "ks_processing_IB"
author: "Indra Boving"
date: "5/21/2022"
output: html_document
---

```{r setup, include=FALSE}
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
```

![QUDO Physiological Thresholds, from Weitz 2018; Jacobson and Pratt found P50 of -5.10](images/Screen%20Shot%202022-05-29%20at%203.46.12%20PM.png)

Read in data:

NOTE: add SLA, corresponding predawns, and TLPs?

```{r}
ks_data <- read_csv(here("data", "ks_data", "ks_alldates.csv")) %>% 
  clean_names() %>% 
  mutate(date = lubridate::mdy(date)) %>% 
  mutate(week = week(date)) %>% 
 # mutate(tree = as.factor(tree)) %>% 
  mutate(alas = total_area/sapwood_area, #make columns we want 
         prop_0yr = length_y0_mm/length_total_mm, 
         prop_1yr = length_y1_mm/length_total_mm, 
         prop_2yr = length_y2_mm/length_total_mm, 
         prop_3yr = length_y3_mm/length_total_mm)
# %>% 
# dplyr::mutate(plc = dplyr::case_when( ####this isn't working....!!!
#   plc < 0 ~ 0,
#   #plc > 100 ~ NA_real_,
#   TRUE == as.numeric(plc)
# ))

dlookr::diagnose(ks_data)
```

Read in water potential data: 

Note: we measured Ks on stems collected on "2022-04-25" "2022-03-27" "2022-04-12" and "2022-05-23"

```{r}
####### Water Potentials 
#Date: 228 WP + LWC
wpwc228 <- read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="228 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 38-311 WP + LWC
wpwc38 <-  read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="38-311 WP + LWC", skip=5, na = "NA") %>% clean_names()
# remove mislabeled tree 2567 which was actually 2367 
wpwc38 <- wpwc38[-which(wpwc38$tag=="2567"),]

#Date: 315 WP + LWC
wpwc315 <- read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="315 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 325 WP + LWC
wpwc325 <- read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="325 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 330 WP + LWC (core)
wpwc330 <- read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="330 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 411-412 WP + LWC (satellite)
wpwc44 <- read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="44 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 411-412 WP + LWC
wpwc411 <-read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="411-412 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 411-412 WP + LWC
wpwc413 <-read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="413-414 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 425 WP + LWC
wpwc425 <-read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="425 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 427 WP + LWC
wpwc427 <-read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="427 WP + LWC", skip=5, na = "NA") %>% clean_names()

#Date: 523-525 WP + LWC
wpwc523 <-read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="523 WP + LWC", skip=5, na = "NA") %>% clean_names()

wpwc525 <-read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="525 WP + LWC", skip=5, na = "NA") %>% clean_names()
```
Fix that data to be long: 

```{r}
wp315md <- wpwc315 %>%
  as.data.frame() %>% 
  filter(!is.na(tag)) %>%
  dplyr::select(!matches("_g_")) %>% 
  dplyr::select(1:3,matches("md")) %>% 
  dplyr::select(-md_bulk_wet, -md_bulk_dry, -md_avg) %>% 
  pivot_longer(cols=matches("md[1-9]") 
               , names_to="md"
               , values_to="mpa"
               , values_drop_na=TRUE) %>% 
  mutate(date = mdy("03-15-2022"))

#For 3.25
wp325md <- wpwc325 %>%
  as.data.frame() %>% 
  filter(!is.na(tag)) %>%
  dplyr::select(!matches("_g_")) %>% 
  dplyr::select(1:3,matches("md")) %>% 
  dplyr::select(-md_bulk_wet, -md_bulk_dry, -md_avg) %>% 
  pivot_longer(cols=matches("md[1-9]") 
               , names_to="md"
               , values_to="mpa"
               , values_drop_na=TRUE) %>% 
  mutate(date = mdy("03-25-2022"))

#For 3.30
wp330md <- wpwc330 %>%
  as.data.frame() %>% 
  filter(!is.na(tag)) %>%
  dplyr::select(!matches("_g_")) %>% 
  dplyr::select(1:3,matches("md")) %>% 
  dplyr::select(-md_bulk_wet, -md_bulk_dry, -md_avg) %>% 
  pivot_longer(cols=matches("md[1-9]") 
               , names_to="md"
               , values_to="mpa"
               , values_drop_na=TRUE) %>% 
  mutate(date = mdy("03-30-2022")) 

#For 4.11
wp411md <- wpwc411 %>%
  as.data.frame() %>% 
  filter(!is.na(tag)) %>%
  dplyr::select(!matches("_g_")) %>% 
  dplyr::select(1:3,matches("md")) %>% 
  dplyr::select(-md_bulk_wet, -md_bulk_dry, -md_avg) %>% 
  pivot_longer(cols=matches("md[1-9]") 
               , names_to="md"
               , values_to="mpa"
               , values_drop_na=TRUE) %>% 
  mutate(date = mdy("04-11-2022"))


#For 4.13
wp413md <- wpwc413 %>%
  as.data.frame() %>% 
  filter(!is.na(tag)) %>%
  dplyr::select(!matches("_g_")) %>% 
  dplyr::select(1:3,matches("md")) %>% 
  dplyr::select(-md_bulk_wet, -md_bulk_dry, -md_avg) %>% 
  pivot_longer(cols=matches("md[1-9]") 
               , names_to="md"
               , values_to="mpa"
               , values_drop_na=TRUE) %>% 
  mutate(date = mdy("04-13-2022"))

#For 4.25
wp425md <- wpwc425 %>%
  as.data.frame() %>% 
  filter(!is.na(tag)) %>%
  dplyr::select(!matches("_g_")) %>% 
  dplyr::select(1:3,matches("md")) %>% 
  dplyr::select(-md_bulk_wet, -md_bulk_dry, -md_avg) %>% 
  mutate(md1 = as.numeric(md1)) %>% 
  pivot_longer(cols=matches("md[1-9]") 
               , names_to="md"
               , values_to="mpa"
               , values_drop_na=TRUE) %>% 
  mutate(date = mdy("04-25-2022"))

wp523md <- wpwc523 %>%
  as.data.frame() %>% 
  filter(!is.na(tag)) %>%
  dplyr::select(!matches("_g_")) %>% 
  dplyr::select(1:3,matches("md")) %>% 
  dplyr::select(-md_bulk_wet, -md_bulk_dry, -md_avg) %>% 
  pivot_longer(cols=matches("md[1-9]") 
               , names_to="md"
               , values_to="mpa"
               , values_drop_na=TRUE) %>% 
  mutate(date = mdy("05-23-2022"))


###
###Combine all together: 
###

wp_alldates_md <- rbind(wp523md, wp411md, wp325md, wp330md, wp315md, wp425md, wp413md) %>% 
  mutate(week = week(date)) %>% 
  mutate(tree = as.numeric(tag)) 

wp_alldates_md_summary <- wp_alldates_md %>% 
  group_by(date, tag) %>% 
  mutate(mean_md = mean(mpa)) %>% 
  mutate(week_real = week) %>% 
  mutate(week = case_when(
    week == 12 ~ 13, 
    TRUE ~ as.numeric(week))) %>% 
  ungroup() %>% 
  dplyr::select(-date, -plot_number, -species, -md, -mpa)
```

Combine WP data into Ks dataset:

```{r}
ks_data_wp <- merge(ks_data, wp_alldates_md_summary, by = c("tree", "week")) %>% 
  mutate(tree = as.factor(tree)) %>% 
  mutate(date = date) %>% 
  distinct()
```

Read in Ks leaf dry mass data and calculate SLA, LMA: 

```{r}
ks_sla <- read_excel(here("Data_05302022","WP_WC", "SHIFT data collection 2022.xlsx"), sheet="Ks DATA", na = "NA") %>% 
  clean_names() 
  
ks_data_wp_sla <- merge(ks_data_wp, ks_sla, by = c("tree", "date", "branch"), all.x = T) %>% 
  mutate(tree = as.factor(tree)) %>% 
  distinct() %>% 
  mutate(sla_mm_g = total_area/dry_wt_g, 
         lma_g_mm = dry_wt_g/total_area) %>% 
   mutate(tree_id = tree, #change names to be better
          k_max = k_g_mm_s_m_pa_nat, 
          k_nat = k_g_mm_s_m_pa_nat, 
          Ks_max = ks_g_s_mm_m_pa_max, 
          Ks_nat = ks_g_s_mm_m_pa_nat, 
          Kl_max = kl_g_s_mm_m_pa_max, 
          Kl_nat = kl_g_s_mm_m_pa_nat) %>% 
  mutate(plc_new = if_else(plc < 0, 0, plc)) %>% 
  #filter(plc_new > -100) %>% 
  select(-mean_plc_tree)
```

Look at it all: 

#Correlations: 

```{r}
ggally_plot <- ks_data_wp_sla %>% 
  select(k_max, k_nat, Ks_max, Ks_nat, Kl_max, Kl_nat, plc, sla_mm_g, lma_g_mm, alas, mean_md,tree_id) %>% 
   filter(sla_mm_g < 300) %>% #some absurdly large values (why? --> check later) 
  as.data.frame() %>% 
  drop_na()

#dlookr::diagnose(ggally_plot)

GGally::ggpairs(ggally_plot, ggplot2::aes(color = tree_id)) #also not working? Error in is.finite(x) : default method not implemented for type 'list'
```


#Hydraulics over time: 

```{r}
ks_data_wp %>% 
  ggplot(aes(y = mean_md, x = date, color = tree)) +
  geom_point() + 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) 
```

```{r}
ks_data_wp_sla %>% 
  filter(ks_g_s_mpa_nat < 0) %>% 
ggplot(aes(y = k_nat, x = mean_md, color = tree)) +
  geom_point() + 
  geom_smooth(method = "lm", se = F)
  ggtitle("flow over time")
```

Not much of a trend, and possible leaks that were included?

```{r}
ks_data_wp %>% 
ggplot(aes(y = kl_g_s_mm_m_pa_nat, x = date, color = tree)) +
  geom_point() + 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) +
  ggtitle("Kleaf over time")
```

```{r}
ks_data_wp %>% 
ggplot(aes(y = ks_g_s_mm_m_pa_max, x = date, color = tree)) +
  geom_point() + 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) +
  ggtitle("Kstem max over time")
```

```{r}
ks_data_wp %>% 
  filter(ks_g_s_mm_m_pa_max > 0) %>% 
ggplot(aes(y = ks_g_s_mm_m_pa_nat, x = date, color = tree)) +
  geom_point()+ 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) +
  ggtitle("Kstem native over time")
```

```{r}
ks_data_wp %>% 
  filter(ks_g_s_mm_m_pa_max > 0) %>% 
ggplot(aes(y = ks_g_s_mm_m_pa_nat, x = total_area, color = tree)) +
  geom_point()+ 
  geom_smooth(method = "lm", se = F) +
  ggtitle("Kstem native by leaf area")
```

Higher leaf area = greater flow...makes sense.

```{r}
ks_data_wp %>% 
  filter(plc > 0) %>% 
ggplot(aes(y = plc, x = date, color = tree)) +
  geom_point()+ 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) +
  ggtitle("PLC over time")
```

These are mega high PLC values...vacuum infiltration maybe doesn't work as well as hoped? Or we did a bad job collecting? Not sure how to do it better that we did, though....bigger branches? Collect at night?

```{r}
ks_data_wp %>% 
  filter(plc > 0) %>% 
ggplot(aes(y = plc, x = mean_md*-1, color = tree)) +
  geom_point()+ 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) +
  ggtitle("'Natural Vulnerability Curve'")
```

Something may be off with those very wet 2347s...look back at notes?

```{r}
ks_data_wp %>% 
  filter(plc > 0) %>% 
ggplot(aes(y = ks_g_s_mm_m_pa_nat, x = mean_md*-1, color = tree)) +
  geom_point()+ 
  geom_smooth(method = "lm", se = F) +
  ggtitle("Ks curve")
```

Also look back at outliers - some very high Ks values for 2343.

```{r}
ks_data %>% 
  filter(plc > 0) %>% 
ggplot(aes(y = log(alas), x = k_g_mm_s_m_pa_nat, color = as.factor(tree))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ggtitle("log(Al:As) vs. flow")

```

```{r}
ks_data_wp %>% 
  filter(plc > 0) %>% 
ggplot(aes(y = alas, x = k_g_mm_s_m_pa_nat, color = tree)) +
  geom_smooth(method = "lm", se = F) +
  geom_point() +
  ggtitle("log(Al:As) vs. flow")
```

```{r}
ks_data_wp %>% 
ggplot(aes(y = total_area, x = date, color = tree)) +
  geom_point()+ 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) +
  ggtitle("temporal changes in leaf area")
```

```{r}
ks_data_wp %>% 
ggplot(aes(y = length_total_mm, x = date, color = tree)) +
  geom_point()+ 
  stat_summary(fun.y="mean", geom="line", aes(group=factor(tree))) +
  ggtitle("temporal changes in stem length")
```

#Stem proportions:
```{r}
ks_data_wp_sla %>% 
  ggplot(aes(y = prop_)
```

